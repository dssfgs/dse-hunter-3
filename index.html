<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <title>æ•¸å­¸å‹‡è€… V1.2ï¼šå±¬æ€§æˆé•·ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <style>
        :root { --gold: #d4af37; --bg: #020617; --card: #1e293b; --accent: #38bdf8; --red: #ef4444; --green: #10b981; --purple: #a855f7; --text: #f8fafc; }
        body { background: var(--bg); color: var(--text); font-family: 'PingFang HK', sans-serif; margin: 0; padding: 10px; display: flex; justify-content: center; overflow-x: hidden; }
        .app-container { width: 100%; max-width: 480px; display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--card); border: 2px solid var(--gold); border-radius: 20px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); position: relative; }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--accent); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: none; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .opt-btn { background: #334155; color: white; border: 1px solid #475569; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 15px; transition: 0.2s; outline: none; width: 100%; }
        .opt-btn:active { transform: scale(0.96); background: var(--gold); color: black; }
        .attribute-btn { background: linear-gradient(135deg, #334155, #1e293b); border: 2px solid var(--accent); }
        .boss-btn { background: #1e293b; color: #475569; border: 2px dashed #475569; opacity: 0.6; pointer-events: none; }
        .boss-btn.unlocked { background: linear-gradient(45deg, var(--purple), var(--red)); color: white; border: none; opacity: 1; pointer-events: auto; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 10px var(--purple); } 50% { box-shadow: 0 0 20px var(--red); } 100% { box-shadow: 0 0 10px var(--purple); } }
        .analysis-box { font-size: 13px; background: rgba(56, 189, 248, 0.1); border-left: 5px solid var(--accent); padding: 15px; border-radius: 10px; margin: 15px 0; display: flex; align-items: center; gap: 15px; }
        #weakness-chart { width: 50px; height: 50px; border-radius: 50%; flex-shrink: 0; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        .modal-content { background: var(--card); width: 85%; max-width: 380px; padding: 25px; border-radius: 25px; border: 2px solid var(--gold); max-height: 80vh; overflow-y: auto; }
        #privacy-notice { position: fixed; top: 10px; width: 85%; max-width: 400px; background: var(--card); border: 2px solid var(--accent); padding: 15px; border-radius: 15px; z-index: 2000; display: none; }
        .attribute-badge { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; display: inline-block; margin: 2px; }
        .attribute-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .subtype-btn { background: #475569; border: 1px solid #64748b; padding: 12px; border-radius: 10px; font-size: 14px; }
        .subtype-btn:hover { background: #4ade80; color: black; }
        .back-btn { background: #475569; border: none; padding: 10px; border-radius: 10px; color: white; cursor: pointer; margin-bottom: 15px; }
        .stats-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .stat-item { background: rgba(56, 189, 248, 0.1); border-radius: 10px; padding: 10px; text-align: center; }
        .stat-value { font-size: 20px; font-weight: bold; color: var(--gold); }
        .stat-label { font-size: 12px; color: #94a3b8; }
        .level-badge { background: var(--gold); color: black; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; margin-left: 5px; }
        .error-item { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--red); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .error-type { color: var(--accent); font-size: 12px; margin-bottom: 5px; }
        .error-question { margin: 10px 0; }
        .error-answer { background: rgba(16, 185, 129, 0.1); color: var(--green); padding: 8px; border-radius: 5px; margin: 5px 0; }
        .error-actions { display: flex; justify-content: space-between; margin-top: 10px; }
        .challenge-btn { background: var(--gold); color: black; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; cursor: pointer; }
        .delete-btn { background: none; border: 1px solid var(--red); color: var(--red); padding: 5px 10px; border-radius: 5px; font-size: 12px; cursor: pointer; }
        .attr-icon { font-size: 20px; display: block; margin-bottom: 5px; }
        .str-color { color: #ef4444; }
        .int-color { color: #3b82f6; }
        .luc-color { color: #10b981; }
        .wis-color { color: #8b5cf6; }
        .dex-color { color: #f59e0b; }
        .vit-color { color: #ec4899; }
    </style>
</head>
<body>

<div id="privacy-notice">
    ğŸ›¡ï¸ æ•¸æ“šæœ¬åœ°å­˜å„²è²æ˜ï¼šæœ¬ç¨‹å¼ä¸æ”¶é›†å€‹äººè³‡æ–™ã€‚
    <button onclick="Core.acceptPrivacy()" style="background:var(--accent); border:none; padding:5px; border-radius:5px; cursor:pointer;">åŒæ„</button>
</div>

<div class="app-container">
    <!-- åˆå§‹è¨­ç½®è¦–åœ– -->
    <div id="view-setup" class="card">
        <h2 style="color:var(--gold); text-align:center;">æ•¸å­¸å‹‡è€… V1.2</h2>
        <p style="text-align:center; color:#94a3b8; font-size:14px;">RPGå±¬æ€§æˆé•·ç³»çµ± - å…¬å¼è®Šæ›å¢å¼·ç‰ˆ</p>
        <input type="text" id="in-name" placeholder="è¼¸å…¥å‹‡è€…åç¨±" style="width:100%; padding:15px; margin-bottom:15px; border-radius:10px; background:#020617; color:white; border:1px solid #334155; box-sizing:border-box;">
        <button onclick="Core.handleStart()" class="opt-btn" style="background:var(--gold); color:black;">å‰µå»ºè§’è‰²</button>
    </div>

    <!-- ä¸»è¦–åœ– -->
    <div id="view-main" class="card" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span id="ds-name" style="font-weight:900; color:var(--gold);">---</span>
            <div style="display:flex; gap:5px;">
                <span class="level-badge">Lv <span id="ds-level">1</span></span>
                <span class="level-badge" style="background:var(--accent);">XP: <span id="ds-exp">0</span></span>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-item">
                <div class="stat-value str-color" id="stat-str">0</div>
                <div class="stat-label"><span class="attr-icon str-color">âš”ï¸</span> STR</div>
            </div>
            <div class="stat-item">
                <div class="stat-value int-color" id="stat-int">0</div>
                <div class="stat-label"><span class="attr-icon int-color">ğŸ§ </span> INT</div>
            </div>
            <div class="stat-item">
                <div class="stat-value luc-color" id="stat-luc">0</div>
                <div class="stat-label"><span class="attr-icon luc-color">ğŸ€</span> LUC</div>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-item">
                <div class="stat-value wis-color" id="stat-wis">0</div>
                <div class="stat-label"><span class="attr-icon wis-color">ğŸ“–</span> WIS</div>
            </div>
            <div class="stat-item">
                <div class="stat-value dex-color" id="stat-dex">0</div>
                <div class="stat-label"><span class="attr-icon dex-color">ğŸ¯</span> DEX</div>
            </div>
            <div class="stat-item">
                <div class="stat-value vit-color" id="stat-vit">0</div>
                <div class="stat-label"><span class="attr-icon vit-color">â¤ï¸</span> VIT</div>
            </div>
        </div>

        <div class="analysis-box">
            <div id="weakness-chart"></div>
            <div id="ai-recommendation">é¸æ“‡ä¿®ç…‰é …ç›®...</div>
        </div>

        <!-- ä¸»é¸å–® -->
        <div id="main-menu">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button onclick="Core.showAttributeMenu('STR')" class="opt-btn" style="border-color:var(--red);">âš”ï¸ STR ä¿®ç…‰</button>
                <button onclick="Core.showAttributeMenu('INT')" class="opt-btn" style="border-color:var(--accent);">ğŸ§  INT ä¿®ç…‰</button>
                <button onclick="Core.showAttributeMenu('WIS')" class="opt-btn" style="border-color:var(--purple);">ğŸ“– WIS ä¿®ç…‰</button>
                <button onclick="Core.showAttributeMenu('EXT')" class="opt-btn attribute-btn">ğŸŒ€ æ“´å±•å–®å…ƒ</button>
                <button onclick="Core.openErrorLog()" class="opt-btn" style="background:var(--red); border:none;">ğŸ“– éŒ¯èª¤ä¹‹æ›¸ (<span id="error-count">0</span>)</button>
                <button id="btn-boss-tri" onclick="Core.handleSync('BOSS_TRI')" class="opt-btn boss-btn">ğŸ”± ä¸‰è§’è©¦ç…‰</button>
                <button id="btn-boss-prob" onclick="Core.handleSync('BOSS_PROB')" class="opt-btn boss-btn">ğŸ² æ¦‚ç‡è¿·å®®</button>
            </div>
            <button onclick="Core.reset()" style="margin-top:20px; background:none; border:1px solid #475569; color:#475569; width:100%; cursor:pointer; padding:15px; border-radius:12px;">é‡ç½®è§’è‰²</button>
        </div>

        <!-- STR ä¿®ç…‰é¸å–® -->
        <div id="menu-STR" class="attribute-menu" style="display:none;">
            <button class="back-btn" onclick="Core.backToMain()">â† è¿”å›</button>
            <h3 style="color:var(--red);">âš”ï¸ STR ä¿®ç…‰ - åŠ›é‡æŒ‘æˆ°</h3>
            <div class="attribute-selector">
                <button onclick="Core.handleSync('STR_LINEAR')" class="subtype-btn">ç·šæ€§æ–¹ç¨‹</button>
                <button onclick="Core.handleSync('STR_QUADRATIC')" class="subtype-btn">äºŒæ¬¡æ–¹ç¨‹</button>
                <button onclick="Core.handleSync('STR_SIMULTANEOUS')" class="subtype-btn">è¯ç«‹æ–¹ç¨‹</button>
                <button onclick="Core.handleSync('STR_INDEX_LAWS')" class="subtype-btn">æŒ‡æ•¸å®šå¾‹</button>
                <button onclick="Core.handleSync('STR_FACTORIZATION')" class="subtype-btn">å› å¼åˆ†è§£</button>
                <button onclick="Core.handleSync('STR_FORMULA')" class="subtype-btn">å…¬å¼è®Šæ›</button>
		<button onclick="Core.handleSync('STR_EXPONENT')" class="subtype-btn">æŒ‡æ•¸æ–¹ç¨‹</button>
		<button onclick="Core.handleSync('STR_EXPONENT_LAWS')" class="subtype-btn">æŒ‡æ•¸å®šå¾‹</button>
            </div>
        </div>

        <!-- INT ä¿®ç…‰é¸å–® -->
        <div id="menu-INT" class="attribute-menu" style="display:none;">
            <button class="back-btn" onclick="Core.backToMain()">â† è¿”å›</button>
            <h3 style="color:var(--accent);">ğŸ§  INT ä¿®ç…‰ - æ™ºåŠ›æŒ‘æˆ°</h3>
            <div class="attribute-selector">
                <button onclick="Core.handleSync('INT_COMBINATORICS')" class="subtype-btn">çµ„åˆæ•¸å­¸</button>
                <button onclick="Core.handleSync('INT_LOGIC')" class="subtype-btn">é‚è¼¯æ¨ç†</button>
                <button onclick="Core.handleSync('INT_PATTERN')" class="subtype-btn">æ¨¡å¼è­˜åˆ¥</button>
                <button onclick="Core.handleSync('INT_PROBLEM')" class="subtype-btn">å•é¡Œè§£æ±º</button>
                <button onclick="Core.handleSync('INT_ANALYSIS')" class="subtype-btn">æ•¸å­¸åˆ†æ</button>
                <button onclick="Core.handleSync('INT_SERIES')" class="subtype-btn">æ•¸åˆ—è¨ˆç®—</button>
            </div>
        </div>

        <!-- WIS ä¿®ç…‰é¸å–® -->
        <div id="menu-WIS" class="attribute-menu" style="display:none;">
            <button class="back-btn" onclick="Core.backToMain()">â† è¿”å›</button>
            <h3 style="color:var(--purple);">ğŸ“– WIS ä¿®ç…‰ - æ™ºæ…§æŒ‘æˆ°</h3>
            <div class="attribute-selector">
                <button onclick="Core.handleSync('WIS_GEOMETRY')" class="subtype-btn">å¹¾ä½•è­‰æ˜</button>
                <button onclick="Core.handleSync('WIS_TRIG')" class="subtype-btn">ä¸‰è§’å­¸</button>
                <button onclick="Core.handleSync('WIS_CIRCLE')" class="subtype-btn">åœ“å½¢å¹¾ä½•</button>
                <button onclick="Core.handleSync('WIS_COORDINATE')" class="subtype-btn">åæ¨™å¹¾ä½•</button>
                <button onclick="Core.handleSync('WIS_VOLUME')" class="subtype-btn">é«”ç©è¨ˆç®—</button>
                <button onclick="Core.handleSync('WIS_ANGLE')" class="subtype-btn">è§’åº¦é—œä¿‚</button>
            </div>
        </div>

        <!-- æ“´å±•å–®å…ƒé¸å–® -->
        <div id="menu-EXT" class="attribute-menu" style="display:none;">
            <button class="back-btn" onclick="Core.backToMain()">â† è¿”å›</button>
            <h3 style="color:var(--accent);">ğŸŒ€ è®Šæ•¸èˆ‡åœ“æ–¹ç¨‹</h3>
            <div class="attribute-selector">
                <button onclick="Core.handleSync('EXT_VAR')" class="subtype-btn">è®Šæ•¸ Variation</button>
                <button onclick="Core.handleSync('EXT_CIRCLE')" class="subtype-btn">åœ“æ–¹ç¨‹ Circle</button>
            </div>
        </div>
    </div>

    <!-- éŒ¯èª¤ä¹‹æ›¸è¦–åœ– -->
    <div id="view-errors" class="card" style="display:none;">
        <button class="back-btn" onclick="Core.backToMain()">â† è¿”å›ä¸»é </button>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="color:var(--red);">ğŸ“– éŒ¯èª¤ä¹‹æ›¸</h3>
            <div>
                <button onclick="Core.exportErrors()" style="background:none; border:1px solid var(--accent); color:var(--accent); border-radius:5px; padding:5px 10px; font-size:12px; margin-right:5px;">å°å‡º</button>
                <button onclick="Core.clearErrors()" style="background:none; border:1px solid var(--red); color:var(--red); border-radius:5px; padding:5px 10px; font-size:12px;">æ¸…ç©º</button>
            </div>
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin:15px 0; padding:10px; background:rgba(239,68,68,0.1); border-radius:10px;">
            <div>
                <div style="color:var(--text); font-size:14px;">éŒ¯èª¤çµ±è¨ˆ</div>
                <div style="color:#94a3b8; font-size:12px;">
                    STR: <span id="error-str">0</span> | 
                    INT: <span id="error-int">0</span> | 
                    WIS: <span id="error-wis">0</span>
                </div>
            </div>
            <div style="text-align:right;">
                <div style="color:var(--gold); font-size:14px;">éŒ¯èª¤ç‡</div>
                <div style="color:#94a3b8; font-size:12px;"><span id="error-rate">0%</span></div>
            </div>
        </div>
        
        <div id="error-list" style="max-height:60vh; overflow-y:auto; padding-right:5px;">
            <!-- éŒ¯èª¤åˆ—è¡¨æœƒå‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>
</div>

<!-- ç­”é¡Œæ¨¡æ…‹æ¡† -->
<div id="modal" class="modal">
    <div class="modal-content">
        <div id="loading-spinner" class="spinner"></div>
        <div id="q-body" style="font-size:1.1rem; margin-bottom:20px;"></div>
        <div id="q-options" style="display:grid; gap:10px;"></div>
        <div id="feedback" style="display:none; margin-top:15px; border-top:1px solid #475569; padding-top:10px;">
            <div id="res-title" style="font-size:1.2rem; font-weight:bold;"></div>
            <div id="res-steps" style="font-size:13px; margin:10px 0; color:#cbd5e1;"></div>
            <div id="attribute-gain" style="display:none; margin:10px 0; padding:10px; background:rgba(56, 189, 248, 0.1); border-radius:8px;">
                <span id="gain-text"></span>
            </div>
            <button onclick="document.getElementById('modal').style.display='none'" class="opt-btn" style="background:var(--gold); color:black;">è¿”å›</button>
        </div>
    </div>
</div>

<script>
/** æ ¸å¿ƒé‚è¼¯ */
const MathJaxLoader = {
    loaded: false,
    ensure(cb) {
        if (this.loaded) return cb();
        window.MathJax = { 
            tex: { 
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: true
            }, 
            startup: { 
                typeset: false,
                pageReady: () => {
                    MathJax.startup.defaultPageReady();
                    if(typeof cb === 'function') cb();
                }
            } 
        };
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
        s.async = true;
        s.onload = () => { 
            this.loaded = true; 
            if(typeof cb === 'function') cb();
        };
        s.onerror = () => { 
            console.error("MathJax åŠ è¼‰å¤±æ•—");
            if(typeof cb === 'function') cb();
        };
        document.head.appendChild(s);
    }
};

const Analytics = {
    history: JSON.parse(localStorage.getItem('math_hero_hist') || '[]'),
    errors: JSON.parse(localStorage.getItem('math_hero_errors') || '[]'),
    
    record(type, ok, q) {
        const record = {
            type, 
            ok, 
            time: new Date().toLocaleString('zh-Hant'),
            date: Date.now()
        };
        
        this.history.push(record);
        if(this.history.length > 100) this.history.shift();
        
        // å¦‚æœç­”éŒ¯ï¼Œä¿å­˜éŒ¯èª¤è©³ç´°ä¿¡æ¯
        if(!ok && q) {
            const errorRecord = {
                id: Date.now(),
                type: type,
                time: record.time,
                q: q.q,
                a: q.a,
                s: q.s,
                o: q.o
            };
            this.errors.unshift(errorRecord); // æœ€æ–°çš„éŒ¯èª¤åœ¨å‰é¢
            
            // é™åˆ¶éŒ¯èª¤æ•¸é‡ç‚º50é¡Œ
            if(this.errors.length > 50) this.errors.pop();
            
            localStorage.setItem('math_hero_errors', JSON.stringify(this.errors));
        }
        
        localStorage.setItem('math_hero_hist', JSON.stringify(this.history));
    },
    
    removeError(index) {
        this.errors.splice(index, 1);
        localStorage.setItem('math_hero_errors', JSON.stringify(this.errors));
    },
    
    clearErrors() {
        if(this.errors.length === 0 || !confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰éŒ¯èª¤è¨˜éŒ„å—ï¼Ÿ")) return;
        this.errors = [];
        localStorage.setItem('math_hero_errors', JSON.stringify(this.errors));
        Core.updateErrorUI();
    },
    
    getWeaknessAnalysis() {
        const total = this.history.length || 1;
        const recent = this.history.slice(-20);
        
        if(recent.length === 0) return { failRate: 0, recommendation: "é–‹å§‹ä¿®ç…‰å§ï¼" };
        
        const fails = recent.filter(h => !h.ok).length;
        const failRate = Math.round((fails / recent.length) * 100);
        
        // åˆ†æå„é¡å‹éŒ¯èª¤ç‡
        const typeStats = {};
        recent.forEach(h => {
            const mainType = h.type.split('_')[0];
            typeStats[mainType] = typeStats[mainType] || { total: 0, fails: 0 };
            typeStats[mainType].total++;
            if(!h.ok) typeStats[mainType].fails++;
        });
        
        let recommendation = "ä¿®ç…‰é †åˆ©ï¼Œç¹¼çºŒå‰é€²ï¼";
        for(const [type, stats] of Object.entries(typeStats)) {
            const typeFailRate = Math.round((stats.fails / stats.total) * 100);
            if(typeFailRate > 40) {
                const typeNames = { STR: "åŠ›é‡(STR)", INT: "æ™ºåŠ›(INT)", WIS: "æ™ºæ…§(WIS)", EXT: "æ“´å±•å–®å…ƒ" };
                recommendation = `âš ï¸ ${typeNames[type] || type} éœ€è¦åŠ å¼·ä¿®ç…‰`;
                break;
            }
        }
        
        return { failRate, recommendation };
    },
    
    getErrorStats() {
        const str = this.errors.filter(e => e.type.startsWith('STR')).length;
        const int = this.errors.filter(e => e.type.startsWith('INT')).length;
        const wis = this.errors.filter(e => e.type.startsWith('WIS')).length;
        const ext = this.errors.filter(e => e.type.startsWith('EXT')).length;
        
        const total = this.history.length || 1;
        const failCount = this.history.filter(h => !h.ok).length;
        const errorRate = Math.round((failCount / total) * 100);
        
        return { str, int, wis, ext, errorRate };
    },
    
    updateUI() {
        const analysis = this.getWeaknessAnalysis();
        document.getElementById('weakness-chart').style.background = `conic-gradient(var(--red) ${analysis.failRate}%, var(--green) 0)`;
        document.getElementById('ai-recommendation').textContent = analysis.recommendation;
        document.getElementById('error-count').textContent = this.errors.length;
    }
};

const Generator = {
    rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; },
    
    // STR é¡Œç›®ç”Ÿæˆå™¨ (ä»£æ•¸ç›¸é—œ)
    generateSTR(type, lv = 1) {
        const levelMod = Math.min(5, Math.floor(lv / 2));
        
        if(type === 'STR_LINEAR') {
            const a = this.rand(2, 5 + levelMod);
            const b = this.rand(-10 - levelMod, 10 + levelMod);
            const x = this.rand(-8, 8);
            const c = a * x + b;
            return { 
                q: `è§£æ–¹ç¨‹ï¼š$${a}x ${b >= 0 ? '+' : ''}${b} = ${c}$`, 
                a: `$${x}$`, 
                o: [ `$${x}$`, `$${-x}$`, `$${x+1}$`, `$0$` ], 
                s: [`æ­¥é©Ÿï¼š${c} - ${b} = ${c-b}`, `$${a}x = ${c-b}$`, `$x = ${(c-b)} / ${a} = ${x}$`] 
            };
        }
        
        if(type === 'STR_QUADRATIC') {
            const r1 = this.rand(-5, 5);
            const r2 = this.rand(-5, 5);
            if(r1 === r2) return this.generateSTR('STR_QUADRATIC', lv);
            
            const b = -(r1 + r2);
            const c = r1 * r2;
            
            let equation;
            if(b === 0) {
                equation = `$x^2 ${c >= 0 ? '+' : ''}${c} = 0$`;
            } else if(c === 0) {
                equation = `$x^2 ${b > 0 ? '+' : ''}${b}x = 0$`;
            } else {
                equation = `$x^2 ${b > 0 ? '+' : ''}${b}x ${c >= 0 ? '+' : ''}${c} = 0$`;
            }
            
            const roots = `$x = ${r1}$ æˆ– $x = ${r2}$`;
            
            return {
                q: `è§£æ–¹ç¨‹ï¼š${equation}`,
                a: roots,
                o: [
                    roots,
                    `$x = ${r1+1}$ æˆ– $x = ${r2}$`,
                    `$x = ${r1}$ æˆ– $x = ${r2+1}$`,
                    r1 * r2 > 0 ? "ç„¡å¯¦æ•¸è§£" : `$x = ${-r1}$ æˆ– $x = ${-r2}$`
                ],
                s: [
                    `æ–¹æ³•ä¸€ï¼šå› å¼åˆ†è§£`,
                    `åŸå¼å¯åˆ†è§£ç‚º $(x ${r1 >= 0 ? '-' : '+'}${Math.abs(r1)})(x ${r2 >= 0 ? '-' : '+'}${Math.abs(r2)}) = 0$`,
                    `å¾— $x ${r1 >= 0 ? '-' : '+'}${Math.abs(r1)} = 0$ æˆ– $x ${r2 >= 0 ? '-' : '+'}${Math.abs(r2)} = 0$`,
                    `è§£å¾— $x = ${r1}$ æˆ– $x = ${r2}$`
                ]
            };
        }
        
        if(type === 'STR_SIMULTANEOUS') {
            const x = this.rand(1, 3 + levelMod);
            const y = this.rand(1, 3 + levelMod);
            const a1 = this.rand(1, 3), b1 = this.rand(1, 3);
            const a2 = this.rand(1, 3), b2 = this.rand(1, 3);
            const c1 = a1*x + b1*y;
            const c2 = a2*x + b2*y;
            return { 
                q: `è§£è¯ç«‹æ–¹ç¨‹ï¼š\\begin{cases} ${a1}x ${b1 >= 0 ? '+' : ''}${b1}y = ${c1} \\\\ ${a2}x ${b2 >= 0 ? '+' : ''}${b2}y = ${c2} \\end{cases}`, 
                a: `$x = ${x}, y = ${y}$`, 
                o: [`$x = ${x}, y = ${y}$`, `$x = ${x+1}, y = ${y}$`, `$x = ${x}, y = ${y+1}$`, `$x = ${x-1}, y = ${y-1}$`], 
                s: [`æ–¹æ³•ä¸€ï¼šä»£å…¥æ³•`, `å¾ç¬¬ä¸€å¼å¾— $x = (${c1} - ${b1}y)/${a1}$`, `ä»£å…¥ç¬¬äºŒå¼è§£ $y$`, `æ–¹æ³•äºŒï¼šæ¶ˆå…ƒæ³•`, `å…©å¼ç›¸æ¶ˆæ±‚è§£`] 
            };
        }
        
if(type === 'STR_INDEX_LAWS') {
    const levelMod = Math.min(5, Math.floor(lv / 2));  // ä¾ç­‰ç´šèª¿æ•´é›£åº¦
    const vars = ['x', 'y'];  // DSE å¸¸è¦‹è®Šæ•¸
    const m = this.rand(1, 3 + levelMod);  // æ­£æŒ‡æ•¸ç¯„åœ
    const n = this.rand(1, 3 + levelMod);  // æ­£æŒ‡æ•¸ç¯„åœ
    const k = this.rand(2, 4 + levelMod);  // å†ªæ¬¡
    
    // éš¨æ©Ÿé¸æ“‡é¡Œå‹ï¼ˆDSE å¸¸è¦‹ï¼šè² æŒ‡æ•¸å†ªæ¬¡ã€ä¹˜é™¤çµ„åˆï¼‰
    const lawType = this.rand(1, 3);  // 1: è² å†ªæ¬¡, 2: è² ä¹˜æ³•, 3: è² é™¤æ³•
    let q, a, o, s;
    
    if(lawType === 1) {  // è² å†ªæ¬¡: (x^{-m} y^{-n})^k
        const exp_x = m * k;
        const exp_y = n * k;
        q = `ç°¡åŒ– $(${vars[0]}^{-${m}} ${vars[1]}^{-${n}})^{${k}}$ ä»¥æ­£æŒ‡æ•¸è¡¨ç¤ºã€‚`;
        a = `$\\frac{1}{${vars[0]}^{${exp_x}} ${vars[1]}^{${exp_y}}}$`;
        o = [
            a,
            `$${vars[0]}^{-${exp_x}} ${vars[1]}^{-${exp_y}}$`,
            `$${vars[0]}^{${m + k}} ${vars[1]}^{${n + k}}$`,
            `$${vars[0]}^{${exp_x}} ${vars[1]}^{${exp_y}}$`
        ];
 s: [
    `æ‡‰ç”¨å†ªæ¬¡å®šå¾‹ï¼š$(${vars[0]}^{-${m}})^{${k}} = ${vars[0]}^{-${m} \\times ${k}} = ${vars[0]}^{-${exp_x}}$ï¼ŒåŒæ¨£åœ° $(${vars[1]}^{-${n}})^{${k}} = ${vars[1]}^{-${n} \\times ${k}} = ${vars[1]}^{-${exp_y}}$ã€‚`,
    `å°‡è² æŒ‡æ•¸è½‰ç‚ºæ­£æŒ‡æ•¸ï¼š$${vars[0]}^{-${exp_x}} ${vars[1]}^{-${exp_y}} = \\frac{1}{${vars[0]}^{${exp_x}} ${vars[1]}^{${exp_y}}}$ã€‚`,
    `ç­”æ¡ˆï¼š$\\frac{1}{${vars[0]}^{${exp_x}} ${vars[1]}^{${exp_y}}}$`
];
    } else if(lawType === 2) {  // è² ä¹˜æ³•: x^{-m} Ã— y^{n} Ã— x^{k}
        const exp_x = k - m;  // -m + k
        const exp_y = n;
        
        if(exp_x > 0) {
            q = `ç°¡åŒ– $${vars[0]}^{-${m}} \\times ${vars[1]}^{${n}} \\times ${vars[0]}^{${k}}$ ä»¥æ­£æŒ‡æ•¸è¡¨ç¤ºã€‚`;
            a = `$${vars[0]}^{${exp_x}} ${vars[1]}^{${exp_y}}$`;
            o = [
                a,
                `$${vars[0]}^{-${m + k}} ${vars[1]}^{${n}}$`,
                `$${vars[0]}^{${m * k}} ${vars[1]}^{${n}}$`,
                `$\\frac{${vars[1]}^{${n}}}{${vars[0]}^{${m + k}}}$`
            ];
        } else if(exp_x < 0) {
            const abs_exp_x = Math.abs(exp_x);
            q = `ç°¡åŒ– $${vars[0]}^{-${m}} \\times ${vars[1]}^{${n}} \\times ${vars[0]}^{${k}}$ ä»¥æ­£æŒ‡æ•¸è¡¨ç¤ºã€‚`;
            a = `$\\frac{${vars[1]}^{${exp_y}}}{${vars[0]}^{${abs_exp_x}}}$`;
            o = [
                a,
                `$${vars[0]}^{-${m + k}} ${vars[1]}^{${n}}$`,
                `$${vars[0]}^{${m * k}} ${vars[1]}^{${n}}$`,
                `$${vars[0]}^{${abs_exp_x}} ${vars[1]}^{${exp_y}}$`
            ];
        } else { // exp_x === 0
            q = `ç°¡åŒ– $${vars[0]}^{-${m}} \\times ${vars[1]}^{${n}} \\times ${vars[0]}^{${k}}$ ä»¥æ­£æŒ‡æ•¸è¡¨ç¤ºã€‚`;
            a = `$${vars[1]}^{${exp_y}}$`;
            o = [
                a,
                `$${vars[0]}^{-${m + k}} ${vars[1]}^{${n}}$`,
                `$${vars[0]}^{${m * k}} ${vars[1]}^{${n}}$`,
                `$\\frac{1}{${vars[0]}^{${m}} ${vars[1]}^{${n}} ${vars[0]}^{${k}}}$`
            ];
        }
        
        s = [
            `åˆä½µåŒåº•æ•¸é …ï¼š$${vars[0]}^{-${m}} \\times ${vars[0]}^{${k}} = ${vars[0]}^{-${m} + ${k}} = ${vars[0]}^{${exp_x}}$ã€‚`,
            `å› æ­¤åŸå¼è®Šç‚ºï¼š$${vars[0]}^{${exp_x}} ${vars[1]}^{${n}}$ã€‚`,
            exp_x < 0 ? 
                `å°‡è² æŒ‡æ•¸è½‰ç‚ºæ­£æŒ‡æ•¸ï¼š$${vars[0]}^{${exp_x}} = \\frac{1}{${vars[0]}^{${Math.abs(exp_x)}}}$ï¼Œæ‰€ä»¥ç­”æ¡ˆç‚º $\\frac{${vars[1]}^{${n}}}{${vars[0]}^{${Math.abs(exp_x)}}}$ã€‚` :
                `ç­”æ¡ˆï¼š${a}`
        ];
    } else {  // è² é™¤æ³•: x^{-m} Ã· y^{-n}
        q = `ç°¡åŒ– $${vars[0]}^{-${m}} \\div ${vars[1]}^{-${n}}$ ä»¥æ­£æŒ‡æ•¸è¡¨ç¤ºã€‚`;
        a = `$\\frac{${vars[1]}^{${n}}}{${vars[0]}^{${m}}}$`;
        o = [
            a,
            `$${vars[0]}^{-${m}} ${vars[1]}^{-${n}}$`,
            `$${vars[0]}^{${m}} ${vars[1]}^{${n}}$`,
            `$\\frac{1}{${vars[0]}^{${m}} ${vars[1]}^{${n}}}$`
        ];
        s = [
            `é™¤æ³•å®šå¾‹ï¼š$${vars[0]}^{-${m}} \\div ${vars[1]}^{-${n}} = ${vars[0]}^{-${m}} \\times ${vars[1]}^{${n}}$ã€‚`,
            `å°‡è² æŒ‡æ•¸è½‰ç‚ºæ­£æŒ‡æ•¸ï¼š$${vars[0]}^{-${m}} = \\frac{1}{${vars[0]}^{${m}}}$ã€‚`,
            `æ‰€ä»¥ç­”æ¡ˆç‚º $\\frac{${vars[1]}^{${n}}}{${vars[0]}^{${m}}}$ã€‚`
        ];
    }
    
    return { q: q, a: a, o: o, s: s };
}
        
        if(type === 'STR_FACTORIZATION') {
            const factor = this.rand(2, 4);
            const innerA = this.rand(1, 3);
            const innerB = this.rand(-3, 3);
            const expression = `$${factor}${innerA > 1 ? innerA : ''}x ${innerB >= 0 ? '+' : ''}${innerB * factor}$`;
            const factored = `$${factor}(${innerA > 1 ? innerA : ''}x ${innerB >= 0 ? '+' : ''}${innerB})$`;
            return { 
                q: `å› å¼åˆ†è§£ï¼š${expression}`, 
                a: factored, 
                o: [factored, `$(${factor}x)(${innerA}x ${innerB >= 0 ? '+' : ''}${innerB})$`, `$x(${factor*innerA}x ${innerB >= 0 ? '+' : ''}${innerB*factor})$`, `ç„¡æ³•åˆ†è§£`], 
                s: [`æå–å…¬å› å¼ $${factor}$`, `åŸå¼ = $${factor} \\times ${innerA > 1 ? innerA : ''}x + ${factor} \\times ${innerB}$`, `= $${factor}(${innerA > 1 ? innerA : ''}x ${innerB >= 0 ? '+' : ''}${innerB})$`] 
            };
        }
        
        if(type === 'STR_FORMULA') {
            const formulas = [
                {
                    name: "ç‰›é “ç¬¬äºŒå®šå¾‹",
                    f: "$F = ma$", 
                    description: "åŠ› = è³ªé‡ Ã— åŠ é€Ÿåº¦",
                    given: "F, m", 
                    find: "a", 
                    F: this.rand(10, 30), 
                    m: this.rand(2, 8)
                },
                {
                    name: "é‹å‹•å­¸å…¬å¼",
                    f: "$v = u + at$", 
                    description: "æœ«é€Ÿåº¦ = åˆé€Ÿåº¦ + åŠ é€Ÿåº¦ Ã— æ™‚é–“",
                    given: "u, a, t", 
                    find: "v", 
                    u: this.rand(0, 5), 
                    a: this.rand(1, 4), 
                    t: this.rand(2, 6)
                },
                {
                    name: "åœ“é¢ç©å…¬å¼",
                    f: "$A = \\pi r^2$", 
                    description: "åœ“é¢ç© = Ï€ Ã— åŠå¾‘Â²",
                    given: "A", 
                    find: "r", 
                    A: this.rand(12, 64)
                },
                {
                    name: "å‹¾è‚¡å®šç†",
                    f: "$a^2 + b^2 = c^2$", 
                    description: "ç›´è§’ä¸‰è§’å½¢æ–œé‚ŠÂ² = å…©ç›´è§’é‚ŠÂ²ä¹‹å’Œ",
                    given: "a, b", 
                    find: "c", 
                    a: this.rand(3, 6), 
                    b: this.rand(4, 8)
                },
                {
                    name: "æ­å§†å®šå¾‹",
                    f: "$V = IR$", 
                    description: "é›»å£“ = é›»æµ Ã— é›»é˜»",
                    given: "V, R", 
                    find: "I", 
                    V: this.rand(12, 24), 
                    R: this.rand(3, 8)
                },
                {
                    name: "å‹•èƒ½å…¬å¼",
                    f: "$E_k = \\frac{1}{2}mv^2$", 
                    description: "å‹•èƒ½ = Â½ Ã— è³ªé‡ Ã— é€Ÿåº¦Â²",
                    given: "m, v", 
                    find: "E_k", 
                    m: this.rand(2, 5), 
                    v: this.rand(4, 10)
                },
                {
                    name: "å¯†åº¦å…¬å¼",
                    f: "$\\rho = \\frac{m}{V}$", 
                    description: "å¯†åº¦ = è³ªé‡ Ã· é«”ç©",
                    given: "m, Ï", 
                    find: "V", 
                    m: this.rand(10, 30), 
                    Ï: this.rand(2, 5)
                },
                {
                    name: "åŠŸçš„å…¬å¼",
                    f: "$W = Fs$", 
                    description: "åŠŸ = åŠ› Ã— ä½ç§»",
                    given: "F, s", 
                    find: "W", 
                    F: this.rand(5, 15), 
                    s: this.rand(2, 8)
                }
            ];
            
            const formula = formulas[this.rand(0, formulas.length-1)];
            
            let q, a, steps;
            
            switch(formula.name) {
                case "ç‰›é “ç¬¬äºŒå®šå¾‹":
                    const acceleration = (formula.F / formula.m).toFixed(1);
                    q = `æ ¹æ“šå…¬å¼ ${formula.f}ï¼ˆ${formula.description}ï¼‰ï¼Œå·²çŸ¥ $F = ${formula.F}$ Nï¼Œ$m = ${formula.m}$ kgï¼Œæ±‚åŠ é€Ÿåº¦ $a$`;
                    a = `$${acceleration}$ m/sÂ²`;
                    steps = [
                        `ç”± $F = ma$ å¾— $a = \\frac{F}{m}$`,
                        `$a = \\frac{${formula.F}}{${formula.m}} = ${acceleration}$ m/sÂ²`
                    ];
                    break;
                    
                case "é‹å‹•å­¸å…¬å¼":
                    const finalVelocity = formula.u + formula.a * formula.t;
                    q = `æ ¹æ“šå…¬å¼ ${formula.f}ï¼ˆ${formula.description}ï¼‰ï¼Œå·²çŸ¥åˆé€Ÿåº¦ $u = ${formula.u}$ m/sï¼ŒåŠ é€Ÿåº¦ $a = ${formula.a}$ m/sÂ²ï¼Œæ™‚é–“ $t = ${formula.t}$ sï¼Œæ±‚æœ«é€Ÿåº¦ $v$`;
                    a = `$${finalVelocity}$ m/s`;
                    steps = [
                        `$v = u + at$`,
                        `$v = ${formula.u} + ${formula.a} \\times ${formula.t}$`,
                        `$v = ${formula.u} + ${formula.a * formula.t} = ${finalVelocity}$ m/s`
                    ];
                    break;
                    
                case "åœ“é¢ç©å…¬å¼":
                    const radius = Math.sqrt(formula.A / Math.PI).toFixed(2);
                    q = `æ ¹æ“šå…¬å¼ ${formula.f}ï¼ˆ${formula.description}ï¼‰ï¼Œå·²çŸ¥åœ“é¢ç© $A = ${formula.A}$ï¼Œæ±‚åŠå¾‘ $r$ (Ï€å–3.14)`;
                    a = `$${radius}$`;
                    steps = [
                        `ç”± $A = \\pi r^2$ å¾— $r = \\sqrt{\\frac{A}{\\pi}}$`,
                        `$r = \\sqrt{\\frac{${formula.A}}{3.14}} â‰ˆ \\sqrt{${(formula.A/3.14).toFixed(2)}} â‰ˆ ${radius}$`
                    ];
                    break;
                    
                case "å‹¾è‚¡å®šç†":
                    const hypotenuse = Math.sqrt(formula.a**2 + formula.b**2).toFixed(1);
                    q = `æ ¹æ“šå…¬å¼ ${formula.f}ï¼ˆ${formula.description}ï¼‰ï¼Œå·²çŸ¥ç›´è§’ä¸‰è§’å½¢å…©ç›´è§’é‚Š $a = ${formula.a}$ï¼Œ$b = ${formula.b}$ï¼Œæ±‚æ–œé‚Š $c$`;
                    a = `$${hypotenuse}$`;
                    steps = [
                        `$c = \\sqrt{a^2 + b^2}$`,
                        `$c = \\sqrt{${formula.a}^2 + ${formula.b}^2}$`,
                        `$c = \\sqrt{${formula.a**2} + ${formula.b**2}} = \\sqrt{${formula.a**2 + formula.b**2}} â‰ˆ ${hypotenuse}$`
                    ];
                    break;
                    
                case "æ­å§†å®šå¾‹":
                    const current = (formula.V / formula.R).toFixed(2);
                    q = `æ ¹æ“šå…¬å¼ ${formula.f}ï¼ˆ${formula.description}ï¼‰ï¼Œå·²çŸ¥é›»å£“ $V = ${formula.V}$ Vï¼Œé›»é˜» $R = ${formula.R}$ Î©ï¼Œæ±‚é›»æµ $I$`;
                    a = `$${current}$ A`;
                    steps = [
                        `ç”± $V = IR$ å¾— $I = \\frac{V}{R}$`,
                        `$I = \\frac{${formula.V}}{${formula.R}} = ${current}$ A`
                    ];
                    break;
                    
                case "å‹•èƒ½å…¬å¼":
                    const kineticEnergy = (0.5 * formula.m * formula.v**2).toFixed(1);
                    q = `æ ¹æ“šå…¬å¼ ${formula.f}ï¼ˆ${formula.description}ï¼‰ï¼Œå·²çŸ¥è³ªé‡ $m = ${formula.m}$ kgï¼Œé€Ÿåº¦ $v = ${formula.v}$ m/sï¼Œæ±‚å‹•èƒ½ $E_k$`;
                    a = `$${kineticEnergy}$ J`;
                    steps = [
                        `$E_k = \\frac{1}{2}mv^2$`,
                        `$E_k = 0.5 \\times ${formula.m} \\times ${formula.v}^2$`,
                        `$E_k = 0.5 \\times ${formula.m} \\times ${formula.v**2} = ${kineticEnergy}$ J`
                    ];
                    break;
                    
                case "å¯†åº¦å…¬å¼":
                    const volume = (formula.m / formula.Ï).toFixed(2);
                    q = `æ ¹æ“šå…¬å¼ ${formula.f}ï¼ˆ${formula.description}ï¼‰ï¼Œå·²çŸ¥è³ªé‡ $m = ${formula.m}$ gï¼Œå¯†åº¦ $\\rho = ${formula.Ï}$ g/cmÂ³ï¼Œæ±‚é«”ç© $V$`;
                    a = `$${volume}$ cmÂ³`;
                    steps = [
                        `ç”± $\\rho = \\frac{m}{V}$ å¾— $V = \\frac{m}{\\rho}$`,
                        `$V = \\frac{${formula.m}}{${formula.Ï}} = ${volume}$ cmÂ³`
                    ];
                    break;
                    
                case "åŠŸçš„å…¬å¼":
                    const work = formula.F * formula.s;
                    q = `æ ¹æ“šå…¬å¼ ${formula.f}ï¼ˆ${formula.description}ï¼‰ï¼Œå·²çŸ¥åŠ› $F = ${formula.F}$ Nï¼Œä½ç§» $s = ${formula.s}$ mï¼Œæ±‚åŠŸ $W$`;
                    a = `$${work}$ J`;
                    steps = [
                        `$W = Fs$`,
                        `$W = ${formula.F} \\times ${formula.s} = ${work}$ J`
                    ];
                    break;
            }


            
            // ç”ŸæˆéŒ¯èª¤é¸é …
            const answerNum = parseFloat(a.replace(/[^\d.-]/g, ''));
            const wrongOptions = [];
            
            // ç¢ºä¿éŒ¯èª¤é¸é …ä¸é‡è¤‡ä¸”ä¸åŒæ–¼æ­£ç¢ºç­”æ¡ˆ
            while(wrongOptions.length < 3) {
                const wrong = answerNum + (Math.random() > 0.5 ? 1 : -1) * this.rand(1, 3);
                const wrongFormatted = formula.name.includes("åŠå¾‘") || formula.name.includes("é«”ç©") ? 
                    `$${wrong.toFixed(2)}$` : `$${wrong}$`;
                if(wrong !== answerNum && !wrongOptions.includes(wrongFormatted)) {
                    wrongOptions.push(wrongFormatted);
                }
            }
            
            return { 
                q: q, 
                a: a, 
                o: [a, ...wrongOptions], 
                s: steps 
            };
        }

if(type === 'STR_EXPONENT') {
    const base = Generator.rand(2, 4);  // åŸºæ•¸ 2~4
    const exp = Generator.rand(2, 4);   // æŒ‡æ•¸ 2~4
    const value = Math.pow(base, exp);  // è¨ˆç®— base^exp
    return { 
        q: `è§£æ–¹ç¨‹ï¼š$${base}^x = ${value}$`, 
        a: `$${exp}$`, 
        o: [`$${exp}$`, `$${exp+1}$`, `$${exp-1}$`, `$${value}$`], 
        s: [`$${base}^x = ${value}$`, `x = \\log_{${base}} ${value}`, `= ${exp} (å› ç‚º ${base}^{${exp}} = ${value})`] 
    };
}

if(type === 'STR_EXPONENT_LAWS') {
    const a = this.rand(2, 5 + levelMod);  // åŸºæ•¸ 2~ (5 + ç­‰ç´šèª¿æ•´)
    const m = this.rand(2, 4 + levelMod);   // æŒ‡æ•¸ m
    const n = this.rand(2, 4 + levelMod);   // æŒ‡æ•¸ n
    
    // éš¨æ©Ÿé¸æ“‡å®šå¾‹é¡å‹ï¼šä¹˜æ³•ã€é™¤æ³•æˆ–å†ªæ¬¡
    const lawType = this.rand(1, 3);
    let q, a_str, o, s;
    
    if(lawType === 1) {  // ä¹˜æ³•å®šå¾‹: a^m * a^n = a^{m+n}
        const value = Math.pow(a, m) * Math.pow(a, n);
        const exp_sum = m + n;
        q = `ç°¡åŒ– $${a}^{${m}} \\times ${a}^{${n}}$`;
        a_str = `$${a}^{${exp_sum}}$`;
        o = [`$${a}^{${exp_sum}}$`, `$${a}^{${m * n}}$`, `$${Math.pow(a, exp_sum)}$`, `$${a}^{${m - n}}$`];
        s = [`æŒ‡æ•¸ä¹˜æ³•å®šå¾‹ï¼š$${a}^{m} \\times ${a}^{n} = ${a}^{m+n}$`, `m + n = ${exp_sum}`, `ç­”æ¡ˆï¼š$${a}^{${exp_sum}}$`];
    } else if(lawType === 2) {  // é™¤æ³•å®šå¾‹: a^m / a^n = a^{m-n}
        const exp_diff = m - n;
        q = `ç°¡åŒ– $${a}^{${m}} / ${a}^{${n}}$`;
        a_str = `$${a}^{${exp_diff}}$`;
        o = [`$${a}^{${exp_diff}}$`, `$${a}^{${m + n}}$`, `$${a}^{${m * n}}$`, `$${a}^{${n - m}}$`];
        s = [`æŒ‡æ•¸é™¤æ³•å®šå¾‹ï¼š$${a}^{m} / ${a}^{n} = ${a}^{m-n}$`, `m - n = ${exp_diff}`, `ç­”æ¡ˆï¼š$${a}^{${exp_diff}}$`];
    } else {  // å†ªæ¬¡å®šå¾‹: (a^m)^n = a^{m*n}
        const exp_prod = m * n;
        q = `ç°¡åŒ– $(${a}^{${m}})^{${n}}$`;
        a_str = `$${a}^{${exp_prod}}$`;
        o = [`$${a}^{${exp_prod}}$`, `$${a}^{${m + n}}$`, `$${Math.pow(a, exp_prod)}$`, `$${a}^{${m - n}}$`];
        s = [`æŒ‡æ•¸å†ªæ¬¡å®šå¾‹ï¼š$$(${a}^{m})^{n} = ${a}^{m \times n}$$`, `$m \times n$ = ${exp_prod}`, `ç­”æ¡ˆï¼š$${a}^{${exp_prod}}$`];
    }
    
    return { q: q, a: a_str, o: o, s: s };
}
        
        return this.generateSTR('STR_LINEAR', lv);
    },


    
    // INT é¡Œç›®ç”Ÿæˆå™¨ (æ™ºåŠ›æŒ‘æˆ°)
    generateINT(type, lv = 1) {
        const levelMod = Math.min(5, Math.floor(lv / 2));
        
        if(type === 'INT_COMBINATORICS') {
            const n = this.rand(3, 6 + levelMod);
            const r = this.rand(2, Math.min(4, n-1));
            const combination = this.combination(n, r);
            const permutation = this.permutation(n, r);
            
            const questions = [
                {
                    q: `å¾ ${n} äººä¸­é¸ ${r} äººçµ„æˆå§”å“¡æœƒï¼Œæœ‰å¤šå°‘ç¨®é¸æ³•ï¼Ÿ`,
                    a: `$${combination}$`,
                    o: [`$${combination}$`, `$${permutation}$`, `$${n * r}$`, `$${n + r}$`],
                    s: [`çµ„åˆæ•¸å…¬å¼ï¼š$C_{${n}}^{${r}} = \\frac{${n}!}{${r}!(${n}-${r})!} = ${combination}$`]
                },
                {
                    q: `å¾ ${n} æœ¬æ›¸ä¸­é¸ ${r} æœ¬æ’åˆ—åœ¨æ›¸æ¶ä¸Šï¼Œæœ‰å¤šå°‘ç¨®æ’åˆ—æ–¹æ³•ï¼Ÿ`,
                    a: `$${permutation}$`,
                    o: [`$${permutation}$`, `$${combination}$`, `$${n * r}$`, `$${n^r}$`],
                    s: [`æ’åˆ—æ•¸å…¬å¼ï¼š$P_{${n}}^{${r}} = \\frac{${n}!}{(${n}-${r})!} = ${permutation}$`]
                }
            ];
            
            return questions[this.rand(0, questions.length-1)];
        }
        
        if(type === 'INT_LOGIC') {
            const logicProblems = [
                {
                    q: "è‹¥æ‰€æœ‰è²“éƒ½æœƒçˆ¬æ¨¹ï¼ŒèŠ±èŠ±æ˜¯è²“ï¼Œå‰‡ï¼š",
                    a: "èŠ±èŠ±æœƒçˆ¬æ¨¹",
                    o: ["èŠ±èŠ±æœƒçˆ¬æ¨¹", "èŠ±èŠ±ä¸æœƒçˆ¬æ¨¹", "èŠ±èŠ±å¯èƒ½æ˜¯ç‹—", "ç„¡æ³•åˆ¤æ–·"],
                    s: ["é€™æ˜¯ä¸‰æ®µè«–æ¨ç†ï¼š", "å¤§å‰æï¼šæ‰€æœ‰è²“éƒ½æœƒçˆ¬æ¨¹", "å°å‰æï¼šèŠ±èŠ±æ˜¯è²“", "çµè«–ï¼šèŠ±èŠ±æœƒçˆ¬æ¨¹"]
                },
                {
                    q: "å¦‚æœä»Šå¤©ä¸‹é›¨ï¼Œæˆ‘å°±ä¸å‡ºé–€ã€‚æˆ‘å‡ºé–€äº†ï¼Œæ‰€ä»¥ï¼š",
                    a: "ä»Šå¤©æ²’ä¸‹é›¨",
                    o: ["ä»Šå¤©æ²’ä¸‹é›¨", "ä»Šå¤©ä¸‹é›¨", "å¯èƒ½ä¸‹é›¨å¯èƒ½ä¸ä¸‹", "ç„¡æ³•åˆ¤æ–·"],
                    s: ["é€™æ˜¯é€†å¦å‘½é¡Œï¼š", "åŸå‘½é¡Œï¼šå¦‚æœä¸‹é›¨â†’ä¸å‡ºé–€", "ç­‰åƒ¹æ–¼ï¼šå¦‚æœå‡ºé–€â†’æ²’ä¸‹é›¨"]
                },
                {
                    q: "æ‰€æœ‰é³¥é¡éƒ½æœƒé£›ï¼Œä¼éµæ˜¯é³¥é¡ï¼Œæ‰€ä»¥ï¼š",
                    a: "ä¼éµä¸ä¸€å®šæœƒé£›",
                    o: ["ä¼éµæœƒé£›", "ä¼éµä¸æœƒé£›", "ä¼éµä¸ä¸€å®šæœƒé£›", "ä¼éµæ˜¯å“ºä¹³å‹•ç‰©"],
                    s: ["ç¬¬ä¸€å€‹å‰ææ˜¯éŒ¯çš„ï¼šä¸æ˜¯æ‰€æœ‰é³¥é¡éƒ½æœƒé£›", "ä¼éµæ˜¯é³¥é¡ä½†ä¸æœƒé£›", "æ‰€ä»¥çµè«–æ˜¯ï¼šä¼éµä¸ä¸€å®šæœƒé£›"]
                }
            ];
            
            return logicProblems[this.rand(0, logicProblems.length-1)];
        }
        
        if(type === 'INT_PATTERN') {
            const patterns = [
                {
                    seq: [2, 4, 6, 8, 10],
                    next: 12,
                    rule: "åŠ 2"
                },
                {
                    seq: [1, 3, 6, 10, 15],
                    next: 21,
                    rule: "åŠ éå¢çš„æ•¸ï¼š+2, +3, +4, +5, +6"
                },
                {
                    seq: [1, 1, 2, 3, 5],
                    next: 8,
                    rule: "æ–æ³¢é‚£å¥‘æ•¸åˆ—ï¼šå‰å…©é …ä¹‹å’Œ"
                },
                {
                    seq: [3, 9, 27, 81],
                    next: 243,
                    rule: "ä¹˜ä»¥3"
                },
                {
                    seq: [2, 5, 10, 17, 26],
                    next: 37,
                    rule: "åŠ éå¢çš„å¥‡æ•¸ï¼š+3, +5, +7, +9, +11"
                },
                {
                    seq: [1, 4, 9, 16, 25],
                    next: 36,
                    rule: "å¹³æ–¹æ•¸ï¼š1Â², 2Â², 3Â², 4Â², 5Â², 6Â²"
                }
            ];
            
            const pattern = patterns[this.rand(0, patterns.length-1)];
            return {
                q: `æ‰¾å‡ºè¦å¾‹ï¼š${pattern.seq.join(', ')}ï¼Œä¸‹ä¸€å€‹æ•¸æ˜¯ï¼Ÿ`,
                a: `$${pattern.next}$`,
                o: [`$${pattern.next}$`, `$${pattern.next+1}$`, `$${pattern.next-1}$`, `$${pattern.seq[pattern.seq.length-1] * 2}$`],
                s: [`è¦å¾‹ï¼š${pattern.rule}`, `ä¸‹ä¸€å€‹æ•¸ = ${pattern.next}`]
            };
        }
        
        if(type === 'INT_PROBLEM') {
            const problems = [
                {
                    q: "ä¸€å€‹æ•¸åŠ ä¸Š5ç­‰æ–¼12ï¼Œé€™å€‹æ•¸æ˜¯å¤šå°‘ï¼Ÿ",
                    a: "$7$",
                    o: ["$7$", "$17$", "$-7$", "$5$"],
                    s: ["è¨­é€™å€‹æ•¸ç‚ºx", "$x + 5 = 12$", "$x = 12 - 5 = 7$"]
                },
                {
                    q: "å°æ˜æœ‰10å…ƒï¼Œè²·äº†3å…ƒçš„ç­†å¾Œé‚„å‰©å¤šå°‘ï¼Ÿ",
                    a: "$7$å…ƒ",
                    o: ["$7$å…ƒ", "$13$å…ƒ", "$3$å…ƒ", "$10$å…ƒ"],
                    s: ["å‰©é¤˜ = åŸæœ‰ - èŠ±è²»", "$10 - 3 = 7$å…ƒ"]
                },
                {
                    q: "ä¸€ç®±è˜‹æœæœ‰24å€‹ï¼Œåˆ†çµ¦6å€‹äººï¼Œæ¯äººå¾—å¹¾å€‹ï¼Ÿ",
                    a: "$4$å€‹",
                    o: ["$4$å€‹", "$6$å€‹", "$24$å€‹", "$18$å€‹"],
                    s: ["æ¯äººå¾— = ç¸½æ•¸ Ã· äººæ•¸", "$24 Ã· 6 = 4$å€‹"]
                }
            ];
            
            return problems[this.rand(0, problems.length-1)];
        }
        
        if(type === 'INT_ANALYSIS') {
            const problems = [
                {
                    q: "$f(x) = 2x + 3$ï¼Œæ±‚ $f(4)$",
                    a: "$11$",
                    o: ["$11$", "$14$", "$5$", "$8$"],
                    s: ["$f(4) = 2 \\times 4 + 3$", "$= 8 + 3 = 11$"]
                },
                {
                    q: "å¦‚æœ $g(x) = x^2 - 1$ï¼Œæ±‚ $g(3)$",
                    a: "$8$",
                    o: ["$8$", "$9$", "$6$", "$10$"],
                    s: ["$g(3) = 3^2 - 1$", "$= 9 - 1 = 8$"]
                },
                {
                    q: "$h(x) = 3x^2 - 2x + 1$ï¼Œæ±‚ $h(2)$",
                    a: "$9$",
                    o: ["$9$", "$5$", "$7$", "$11$"],
                    s: ["$h(2) = 3(2)^2 - 2(2) + 1$", "$= 3 \\times 4 - 4 + 1$", "$= 12 - 4 + 1 = 9$"]
                }
            ];
            
            return problems[this.rand(0, problems.length-1)];
        }
        
        if(type === 'INT_SERIES') {
            const seriesTypes = [
                {
                    name: "ç­‰å·®æ•¸åˆ—",
                    first: this.rand(2, 5),
                    diff: this.rand(2, 4),
                    n: this.rand(5, 8),
                    getSum: function() {
                        return this.n * (2*this.first + (this.n-1)*this.diff) / 2;
                    },
                    getNth: function(n) {
                        return this.first + (n-1)*this.diff;
                    }
                },
                {
                    name: "ç­‰æ¯”æ•¸åˆ—",
                    first: this.rand(2, 4),
                    ratio: this.rand(2, 3),
                    n: this.rand(4, 6),
                    getSum: function() {
                        return this.first * (Math.pow(this.ratio, this.n) - 1) / (this.ratio - 1);
                    },
                    getNth: function(n) {
                        return this.first * Math.pow(this.ratio, n-1);
                    }
                }
            ];
            
            const series = seriesTypes[this.rand(0, seriesTypes.length-1)];
            const isSumQuestion = Math.random() > 0.5;
            
            if(isSumQuestion) {
                const sum = series.getSum();
                return {
                    q: `${series.name}ï¼Œé¦–é … $a_1 = ${series.first}$ï¼Œ${series.name === 'ç­‰å·®æ•¸åˆ—' ? 'å…¬å·®' : 'å…¬æ¯”'} $${series.name === 'ç­‰å·®æ•¸åˆ—' ? 'd' : 'r'} = ${series.diff}$ï¼Œæ±‚å‰ ${series.n} é …å’Œ $S_{${series.n}}$`,
                    a: `$${Math.round(sum)}$`,
                    o: [`$${Math.round(sum)}$`, `$${Math.round(sum)+10}$`, `$${series.first*series.n}$`, `$${series.n*(series.first+series.diff)}$`],
                    s: series.name === 'ç­‰å·®æ•¸åˆ—' ? [
                        `ç­‰å·®æ•¸åˆ—æ±‚å’Œå…¬å¼ï¼š$S_n = \\frac{n(a_1 + a_n)}{2}$`,
                        `å…ˆæ±‚ $a_{${series.n}} = a_1 + (n-1)d = ${series.first} + (${series.n}-1) \\times ${series.diff} = ${series.getNth(series.n)}$`,
                        `$S_{${series.n}} = \\frac{${series.n} \\times (${series.first} + ${series.getNth(series.n)})}{2} = ${sum}$`
                    ] : [
                        `ç­‰æ¯”æ•¸åˆ—æ±‚å’Œå…¬å¼ï¼š$S_n = \\frac{a_1(1 - r^n)}{1 - r}$`,
                        `$S_{${series.n}} = \\frac{${series.first} \\times (1 - ${series.diff}^{${series.n}})}{1 - ${series.diff}}$`,
                        `$= \\frac{${series.first} \\times (1 - ${Math.pow(series.diff, series.n)})}{${1-series.diff}} = ${sum}$`
                    ]
                };
            } else {
                const nth = this.rand(3, series.n);
                const nthValue = series.getNth(nth);
                return {
                    q: `${series.name}ï¼Œé¦–é … $a_1 = ${series.first}$ï¼Œ${series.name === 'ç­‰å·®æ•¸åˆ—' ? 'å…¬å·®' : 'å…¬æ¯”'} $${series.name === 'ç­‰å·®æ•¸åˆ—' ? 'd' : 'r'} = ${series.diff}$ï¼Œæ±‚ç¬¬ ${nth} é … $a_{${nth}}$`,
                    a: `$${nthValue}$`,
                    o: [`$${nthValue}$`, `$${nthValue+series.diff}$`, `$${series.first*nth}$`, `$${series.first+series.diff*(nth-1)}$`],
                    s: series.name === 'ç­‰å·®æ•¸åˆ—' ? [
                        `ç­‰å·®æ•¸åˆ—é€šé …å…¬å¼ï¼š$a_n = a_1 + (n-1)d$`,
                        `$a_{${nth}} = ${series.first} + (${nth}-1) \\times ${series.diff}$`,
                        `$= ${series.first} + ${(nth-1)*series.diff} = ${nthValue}$`
                    ] : [
                        `ç­‰æ¯”æ•¸åˆ—é€šé …å…¬å¼ï¼š$a_n = a_1 \\times r^{n-1}$`,
                        `$a_{${nth}} = ${series.first} \\times ${series.diff}^{${nth}-1}$`,
                        `$= ${series.first} \\times ${Math.pow(series.diff, nth-1)} = ${nthValue}$`
                    ]
                };
            }
        }
        
        return this.generateINT('INT_PROBLEM', lv);
    },
    
    // WIS é¡Œç›®ç”Ÿæˆå™¨ (å¹¾ä½•æ™ºæ…§)
    generateWIS(type, lv = 1) {
        const levelMod = Math.min(5, Math.floor(lv / 2));
        
        if(type === 'WIS_GEOMETRY') {
            const shapes = [
                { name: 'ä¸‰è§’å½¢', type: 'area' },
                { name: 'çŸ©å½¢', type: 'area' },
                { name: 'æ¢¯å½¢', type: 'area' },
                { name: 'å¹³è¡Œå››é‚Šå½¢', type: 'area' },
                { name: 'è±å½¢', type: 'area' },
                { name: 'åœ“å½¢', type: 'area' },
                { name: 'ä¸‰è§’å½¢', type: 'perimeter' },
                { name: 'çŸ©å½¢', type: 'perimeter' }
            ];
            const shapeData = shapes[this.rand(0, shapes.length-1)];
            
            if(shapeData.name === 'ä¸‰è§’å½¢' && shapeData.type === 'area') {
                const b = this.rand(4, 8 + levelMod), h = this.rand(3, 6 + levelMod);
                const area = (b * h) / 2;
                return { 
                    q: `ä¸‰è§’å½¢åº• $${b}$ cmï¼Œé«˜ $${h}$ cmï¼Œæ±‚é¢ç©`, 
                    a: `$${area}$ cmÂ²`, 
                    o: [`$${area}$ cmÂ²`, `$${b*h}$ cmÂ²`, `$${b+h}$ cmÂ²`, `$${b*h*2}$ cmÂ²`], 
                    s: [`ä¸‰è§’å½¢é¢ç© = (åº• Ã— é«˜) Ã· 2`, `= (${b} Ã— ${h}) Ã· 2 = ${area}`] 
                };
            } else if(shapeData.name === 'çŸ©å½¢' && shapeData.type === 'area') {
                const l = this.rand(5, 10 + levelMod), w = this.rand(3, 8 + levelMod);
                const area = l * w;
                return { 
                    q: `çŸ©å½¢é•· $${l}$ cmï¼Œé—Š $${w}$ cmï¼Œæ±‚é¢ç©`, 
                    a: `$${area}$ cmÂ²`, 
                    o: [`$${area}$ cmÂ²`, `$${l+w}$ cmÂ²`, `$${2*(l+w)}$ cmÂ²`, `$${l*w*2}$ cmÂ²`], 
                    s: [`çŸ©å½¢é¢ç© = é•· Ã— é—Š`, `= ${l} Ã— ${w} = ${area}`] 
                };
            } else if(shapeData.name === 'æ¢¯å½¢') {
                const a = this.rand(3, 6), b = this.rand(7, 12), h = this.rand(4, 8);
                const area = ((a + b) * h) / 2;
                return { 
                    q: `æ¢¯å½¢ä¸Šåº• $${a}$ cmï¼Œä¸‹åº• $${b}$ cmï¼Œé«˜ $${h}$ cmï¼Œæ±‚é¢ç©`, 
                    a: `$${area}$ cmÂ²`, 
                    o: [`$${area}$ cmÂ²`, `$${a+b+h}$ cmÂ²`, `$${(a+b)*h}$ cmÂ²`, `$${a*b*h}$ cmÂ²`], 
                    s: [`æ¢¯å½¢é¢ç© = (ä¸Šåº• + ä¸‹åº•) Ã— é«˜ Ã· 2`, `= (${a} + ${b}) Ã— ${h} Ã· 2 = ${area}`] 
                };
            } else if(shapeData.name === 'å¹³è¡Œå››é‚Šå½¢') {
                const b = this.rand(4, 8), h = this.rand(3, 7);
                const area = b * h;
                return { 
                    q: `å¹³è¡Œå››é‚Šå½¢åº• $${b}$ cmï¼Œé«˜ $${h}$ cmï¼Œæ±‚é¢ç©`, 
                    a: `$${area}$ cmÂ²`, 
                    o: [`$${area}$ cmÂ²`, `$${b+h}$ cmÂ²`, `$${b*h/2}$ cmÂ²`, `$${b*h*2}$ cmÂ²`], 
                    s: [`å¹³è¡Œå››é‚Šå½¢é¢ç© = åº• Ã— é«˜`, `= ${b} Ã— ${h} = ${area}`] 
                };
            } else if(shapeData.name === 'è±å½¢') {
                const d1 = this.rand(4, 10 + levelMod);
                const d2 = this.rand(3, 8 + levelMod);
                const area = (d1 * d2) / 2;
                return { 
                    q: `è±å½¢å°è§’ç·šé•· $${d1}$ cm å’Œ $${d2}$ cmï¼Œæ±‚é¢ç©`, 
                    a: `$${area}$ cmÂ²`, 
                    o: [`$${area}$ cmÂ²`, `$${d1*d2}$ cmÂ²`, `$${d1+d2}$ cmÂ²`, `$${2*(d1+d2)}$ cmÂ²`], 
                    s: [`è±å½¢é¢ç© = (å°è§’ç·š1 Ã— å°è§’ç·š2) Ã· 2`, `= (${d1} Ã— ${d2}) Ã· 2 = ${area}`] 
                };
            } else if(shapeData.name === 'åœ“å½¢') {
                const r = this.rand(3, 7 + levelMod);
                const area = Math.PI * r * r;
                return { 
                    q: `åœ“åŠå¾‘ $${r}$ cmï¼Œæ±‚é¢ç© (Ï€â‰ˆ3.14)`, 
                    a: `$${(area).toFixed(1)}$ cmÂ²`, 
                    o: [`$${(area).toFixed(1)}$ cmÂ²`, `$${(2*Math.PI*r).toFixed(1)}$ cmÂ²`, `$${r*r}$ cmÂ²`, `$${(r*2).toFixed(1)}$ cmÂ²`], 
                    s: [`åœ“é¢ç© = Ï€rÂ²`, `= 3.14 Ã— ${r}Â²`, `= 3.14 Ã— ${r*r} = ${area.toFixed(1)}`] 
                };
            } else if(shapeData.name === 'ä¸‰è§’å½¢' && shapeData.type === 'perimeter') {
                const a = this.rand(3, 8), b = this.rand(4, 9), c = this.rand(5, 10);
                const perimeter = a + b + c;
                return { 
                    q: `ä¸‰è§’å½¢ä¸‰é‚Šé•· $${a}$ cm, $${b}$ cm, $${c}$ cmï¼Œæ±‚å‘¨é•·`, 
                    a: `$${perimeter}$ cm`, 
                    o: [`$${perimeter}$ cm`, `$${a*b*c}$ cm`, `$${(a+b+c)/2}$ cm`, `$${a+b}$ cm`], 
                    s: [`ä¸‰è§’å½¢å‘¨é•· = ä¸‰é‚Šä¹‹å’Œ`, `= ${a} + ${b} + ${c} = ${perimeter}`] 
                };
            } else if(shapeData.name === 'çŸ©å½¢' && shapeData.type === 'perimeter') {
                const l = this.rand(4, 10), w = this.rand(3, 8);
                const perimeter = 2 * (l + w);
                return { 
                    q: `çŸ©å½¢é•· $${l}$ cmï¼Œé—Š $${w}$ cmï¼Œæ±‚å‘¨é•·`, 
                    a: `$${perimeter}$ cm`, 
                    o: [`$${perimeter}$ cm`, `$${l*w}$ cm`, `$${l+w}$ cm`, `$${l*w*2}$ cm`], 
                    s: [`çŸ©å½¢å‘¨é•· = 2 Ã— (é•· + é—Š)`, `= 2 Ã— (${l} + ${w}) = ${perimeter}`] 
                };
            }
        }
        
        if(type === 'WIS_TRIG') {
            const angles = [
                { angle: 30, sin: "1/2", cos: "âˆš3/2", tan: "âˆš3/3" },
                { angle: 45, sin: "âˆš2/2", cos: "âˆš2/2", tan: "1" },
                { angle: 60, sin: "âˆš3/2", cos: "1/2", tan: "âˆš3" }
            ];
            const trigFuncs = ["sin", "cos", "tan"];
            const angleData = angles[this.rand(0, angles.length-1)];
            const func = trigFuncs[this.rand(0, trigFuncs.length-1)];
            
            let answer, wrong1, wrong2, wrong3;
            if(func === "sin") {
                answer = angleData.sin;
                wrong1 = angleData.cos;
                wrong2 = angleData.tan;
                wrong3 = func === "sin" && angleData.angle === 30 ? "âˆš3/2" : "1/2";
            } else if(func === "cos") {
                answer = angleData.cos;
                wrong1 = angleData.sin;
                wrong2 = angleData.tan;
                wrong3 = func === "cos" && angleData.angle === 60 ? "âˆš3/2" : "1/2";
            } else {
                answer = angleData.tan;
                wrong1 = angleData.sin;
                wrong2 = angleData.cos;
                wrong3 = func === "tan" && angleData.angle === 45 ? "âˆš3" : "1";
            }
            
            return { 
                q: `æ±‚ $${func} ${angleData.angle}^\\circ$ çš„å€¼`, 
                a: `$${answer}$`, 
                o: [`$${answer}$`, `$${wrong1}$`, `$${wrong2}$`, `$${wrong3}$`], 
                s: [`ç‰¹æ®Šè§’ä¸‰è§’æ¯”ï¼š`, 
                    `$\\sin 30^\\circ = 1/2$, $\\cos 30^\\circ = âˆš3/2$, $\\tan 30^\\circ = âˆš3/3$`,
                    `$\\sin 45^\\circ = âˆš2/2$, $\\cos 45^\\circ = âˆš2/2$, $\\tan 45^\\circ = 1$`,
                    `$\\sin 60^\\circ = âˆš3/2$, $\\cos 60^\\circ = 1/2$, $\\tan 60^\\circ = âˆš3$`] 
            };
        }
        
        if(type === 'WIS_CIRCLE') {
            const r = this.rand(3, 8 + levelMod);
            const choice = this.rand(0,2);
            if(choice === 0) {
                return { 
                    q: `åŠå¾‘ç‚º $${r}$ çš„åœ“é¢ç©ï¼Ÿ (å– $\\pi$)`, 
                    a: `$${r*r}\\pi$`, 
                    o: [`$${r*r}\\pi$`, `$${2*r}\\pi$`, `$${r}\\pi$`, `$${r*r*r}\\pi$`], 
                    s: [`åœ“é¢ç©å…¬å¼ï¼š$\\pi r^2$`, `= $\\pi \\times ${r}^2 = ${r*r}\\pi$`] 
                };
            } else if(choice === 1) {
                return { 
                    q: `ç›´å¾‘ç‚º $${2*r}$ çš„åœ“å‘¨é•·ï¼Ÿ (å– $\\pi$)`, 
                    a: `$${2*r}\\pi$`, 
                    o: [`$${2*r}\\pi$`, `$${r*r}\\pi$`, `$${r}\\pi$`, `$${4*r}\\pi$`], 
                    s: [`åœ“å‘¨é•·å…¬å¼ï¼š$\\pi d$ (dç‚ºç›´å¾‘)`, `= $\\pi \\times ${2*r} = ${2*r}\\pi$`] 
                };
            } else {
                const sectorAngle = this.rand(30, 150);
                const sectorArea = (sectorAngle / 360) * Math.PI * r * r;
                return { 
                    q: `åŠå¾‘ $${r}$ï¼Œåœ“å¿ƒè§’ $${sectorAngle}^\\circ$ çš„æ‰‡å½¢é¢ç©ï¼Ÿ (å– Ï€)`, 
                    a: `$${(sectorAngle/360 * r*r).toFixed(2)}\\pi$`, 
                    o: [`$${(sectorAngle/360 * r*r).toFixed(2)}\\pi$`, `$${r*r}\\pi$`, `$${(sectorAngle/180 * r*r).toFixed(2)}\\pi$`, `$${2*r}\\pi$`], 
                    s: [`æ‰‡å½¢é¢ç© = (åœ“å¿ƒè§’/360) Ã— åœ“é¢ç©`, `= (${sectorAngle}/360) Ã— ${r*r}Ï€`, `= ${(sectorAngle/360 * r*r).toFixed(2)}Ï€`] 
                };
            }
        }
        
        if(type === 'WIS_COORDINATE') {
            const x1 = this.rand(-5, 5), y1 = this.rand(-5, 5);
            const x2 = this.rand(-5, 5), y2 = this.rand(-5, 5);
            const dist = Math.round(Math.sqrt((x2-x1)**2 + (y2-y1)**2) * 10) / 10;
            return { 
                q: `æ±‚é» A(${x1},${y1}) å’Œ B(${x2},${y2}) ä¹‹é–“çš„è·é›¢`, 
                a: `$${dist}$`, 
                o: [`$${dist}$`, `$${Math.abs(x2-x1)+Math.abs(y2-y1)}$`, `$${Math.abs(x2-x1)}$`, `$${Math.abs(y2-y1)}$`], 
                s: [`è·é›¢å…¬å¼ï¼š$\\sqrt{(x_2-x_1)^2 + (y_2-y_1)^2}$`, `= $\\sqrt{(${x2}-${x1})^2 + (${y2}-${y1})^2}$`, `= $\\sqrt{${(x2-x1)**2} + ${(y2-y1)**2}}$`, `= $\\sqrt{${(x2-x1)**2 + (y2-y1)**2}} â‰ˆ ${dist}$`] 
            };
        }
        
        if(type === 'WIS_VOLUME') {
            const shapes = ['ç«‹æ–¹é«”', 'é•·æ–¹é«”', 'åœ“æŸ±é«”'];
            const shape = shapes[this.rand(0, shapes.length-1)];
            
            if(shape === 'ç«‹æ–¹é«”') {
                const s = this.rand(2, 5 + levelMod);
                const vol = s * s * s;
                return { 
                    q: `ç«‹æ–¹é«”é‚Šé•· $${s}$ cmï¼Œæ±‚é«”ç©`, 
                    a: `$${vol}$ cmÂ³`, 
                    o: [`$${vol}$ cmÂ³`, `$${s*s}$ cmÂ³`, `$${6*s*s}$ cmÂ³`, `$${s*12}$ cmÂ³`], 
                    s: [`ç«‹æ–¹é«”é«”ç© = é‚Šé•·Â³`, `= ${s} Ã— ${s} Ã— ${s} = ${vol}`] 
                };
            } else if(shape === 'é•·æ–¹é«”') {
                const l = this.rand(3, 6), w = this.rand(2, 5), h = this.rand(4, 8);
                const vol = l * w * h;
                return { 
                    q: `é•·æ–¹é«”é•· $${l}$ cmï¼Œé—Š $${w}$ cmï¼Œé«˜ $${h}$ cmï¼Œæ±‚é«”ç©`, 
                    a: `$${vol}$ cmÂ³`, 
                    o: [`$${vol}$ cmÂ³`, `$${l+w+h}$ cmÂ³`, `$${2*(l*w + l*h + w*h)}$ cmÂ³`, `$${l*w}$ cmÂ³`], 
                    s: [`é•·æ–¹é«”é«”ç© = é•· Ã— é—Š Ã— é«˜`, `= ${l} Ã— ${w} Ã— ${h} = ${vol}`] 
                };
            } else {
                const r = this.rand(2, 4 + levelMod), h = this.rand(3, 7 + levelMod);
                const vol = Math.PI * r * r * h;
                return { 
                    q: `åœ“æŸ±é«”åŠå¾‘ $${r}$ cmï¼Œé«˜ $${h}$ cmï¼Œæ±‚é«”ç© (å– Ï€)`, 
                    a: `$${r*r*h}\\pi$ cmÂ³`, 
                    o: [`$${r*r*h}\\pi$ cmÂ³`, `$${2*r*h}\\pi$ cmÂ³`, `$${r*h}\\pi$ cmÂ³`, `$${r*r}\\pi$ cmÂ³`], 
                    s: [`åœ“æŸ±é«”ç© = Ï€rÂ²h`, `= Ï€ Ã— ${r}Â² Ã— ${h} = ${r*r*h}Ï€`] 
                };
            }
        }
        
        if(type === 'WIS_ANGLE') {
            const angle1 = this.rand(30, 80), angle2 = this.rand(30, 80);
            const angle3 = 180 - angle1 - angle2;
            return { 
                q: `ä¸‰è§’å½¢å…©å…§è§’ç‚º $${angle1}^\\circ$ å’Œ $${angle2}^\\circ$ï¼Œæ±‚ç¬¬ä¸‰è§’`, 
                a: `$${angle3}^\\circ$`, 
                o: [`$${angle3}^\\circ$`, `$${180-angle1}^\\circ$`, `$${180-angle2}^\\circ$`, `$${angle1+angle2}^\\circ$`], 
                s: [`ä¸‰è§’å½¢å…§è§’å’Œ = 180Â°`, `ç¬¬ä¸‰è§’ = 180Â° - ${angle1}Â° - ${angle2}Â° = ${angle3}Â°`] 
            };
        }
        
        return this.generateWIS('WIS_GEOMETRY', lv);
    },
    
    // æ“´å……ï¼šè®Šæ•¸èˆ‡åœ“æ–¹ç¨‹
    generateEXT(type, lv = 7) {
        const mod = lv - 7;

        // è®Šæ•¸ (Variation) - æ­£è®Šèˆ‡åè®Šç¶œåˆ
        if (type === 'EXT_VAR') {
            const k = this.rand(2, 5);
            const x = this.rand(2, 4);
            const y = this.rand(2, 6);
            // é¡Œç›®é¡å‹ï¼šy = kx^2 æˆ– y = k/sqrt(x)
            const isDirect = Math.random() > 0.5;
            if (isDirect) {
                const constant = y / (x * x);
                const newX = x * 2;
                const newY = y * 4;
                return {
                    q: `å·²çŸ¥ $y$ éš¨ $x^2$ æ­£è®Šã€‚ç•¶ $x = ${x}$ æ™‚ï¼Œ$y = ${y}$ã€‚æ±‚ç•¶ $x = ${newX}$ æ™‚ $y$ çš„å€¼ã€‚`,
                    a: `$${newY}$`,
                    o: [`$${newY}$`, `$${y * 2}$`, `$${newY + 2}$`, `$${y ** 2}$`],
                    s: [`è¨­ $y = kx^2$`, `${y} = k(${x})^2 \\Rightarrow k = ${y}/${x**2}$`, `ç•¶ $x = ${newX}$ï¼Œ$y = (${y}/${x**2}) \\times ${newX}^2 = ${newY}$`]
                };
            } else {
                const val = y * x;
                const newX = x * 2;
                const newY = val / newX;
                return {
                    q: `å·²çŸ¥ $y$ éš¨ $x$ åè®Šã€‚ç•¶ $x = ${x}$ æ™‚ï¼Œ$y = ${y}$ã€‚æ±‚ç•¶ $x = ${newX}$ æ™‚ $y$ çš„å€¼ã€‚`,
                    a: `$${newY}$`,
                    o: [`$${newY}$`, `$${y * 2}$`, `$${y + 2}$`, `$${val}$`],
                    s: [`è¨­ $y = k/x$`, `${y} = k/${x} \\Rightarrow k = ${x * y}$`, `ç•¶ $x = ${newX}$ï¼Œ$y = ${val}/${newX} = ${newY}$`]
                };
            }
        }

        // åœ“æ–¹ç¨‹ (Circle Equations) - ä¸€èˆ¬å¼æ±‚åœ“å¿ƒèˆ‡åŠå¾‘
        if (type === 'EXT_CIRCLE') {
            const h = this.rand(-5, 5);
            const k = this.rand(-5, 5);
            const r = this.rand(2, 6);
            const D = -2 * h;
            const E = -2 * k;
            const F = h * h + k * k - r * r;
            
            const isAskingCenter = Math.random() > 0.5;
            if (isAskingCenter) {
                return {
                    q: `å·²çŸ¥åœ“æ–¹ç¨‹ç‚º $x^2 + y^2 ${D >= 0 ? '+' : ''}${D}x ${E >= 0 ? '+' : ''}${E}y ${F >= 0 ? '+' : ''}${F} = 0$ï¼Œæ±‚åœ“å¿ƒåæ¨™ã€‚`,
                    a: `$(${h}, ${k})$`,
                    o: [`$(${h}, ${k})$`, `$(${-h}, ${-k})$`, `$(${D}, ${E})$`, `$(0, 0)$`],
                    s: [`åœ“å¿ƒå…¬å¼ï¼š$( -D/2 , -E/2 )$`, `åœ“å¿ƒ $= ( -(${D})/2 , -(${E})/2 ) = (${h}, ${k})$`]
                };
            } else {
                return {
                    q: `å·²çŸ¥åœ“æ–¹ç¨‹ç‚º $x^2 + y^2 ${D >= 0 ? '+' : ''}${D}x ${E >= 0 ? '+' : ''}${E}y ${F >= 0 ? '+' : ''}${F} = 0$ï¼Œæ±‚åŠå¾‘ã€‚`,
                    a: `$${r}$`,
                    o: [`$${r}$`, `$${r * r}$`, `$${Math.sqrt(Math.abs(F))}$`, `$${r + 1}$`],
                    s: [`åŠå¾‘å…¬å¼ï¼š$r = \\sqrt{(D/2)^2 + (E/2)^2 - F}$`, `$r = \\sqrt{(${-h})^2 + (${-k})^2 - (${F})}$`, `$r = \\sqrt{${h*h + k*k - F}} = ${r}$`]
                };
            }
        }
        return this.generateEXT('EXT_VAR', lv);
    },
    
    // è¼”åŠ©å‡½æ•¸
    combination(n, r) {
        let result = 1;
        for(let i = 1; i <= r; i++) {
            result = result * (n - i + 1) / i;
        }
        return Math.round(result);
    },
    
    permutation(n, r) {
        let result = 1;
        for(let i = 0; i < r; i++) {
            result *= (n - i);
        }
        return result;
    },
    
    // ä¸»ç”Ÿæˆå‡½æ•¸
    safeGen(type, lv = 1) {
        if(type.startsWith('STR_')) return this.generateSTR(type, lv);
        if(type.startsWith('INT_')) return this.generateINT(type, lv);
        if(type.startsWith('WIS_')) return this.generateWIS(type, lv);
        if(type.startsWith('EXT_')) return this.generateEXT(type, lv);
        
        // BOSSé¡Œ
        if(type === 'BOSS_TRI') {
            const angle = this.rand(30, 60);
            const side = this.rand(5, 12);
            const answer = Math.round(side / Math.tan(angle * Math.PI/180) * 10) / 10;
            return { 
                q: `æ ¹æ“šä¸‰è§’å‡½æ•¸å…¬å¼ï¼Œç›´è§’ä¸‰è§’å½¢ä¸­ï¼Œä¸€éŠ³è§’ $${angle}^\\circ$ï¼Œå°é‚Šé•· $${side}$ï¼Œæ±‚é„°é‚Šé•·åº¦`, 
                a: `$${answer}$`, 
                o: [`$${answer}$`, `$${answer+2}$`, `$${answer-2}$`, `$${side}$`], 
                s: [`$\\tan ${angle}^\\circ = \\frac{å°é‚Š}{é„°é‚Š}$`, `é„°é‚Š = $${side} / \\tan ${angle}^\\circ$`, `$\\tan ${angle}^\\circ â‰ˆ ${Math.tan(angle*Math.PI/180).toFixed(3)}$`, `$â‰ˆ ${side} / ${Math.tan(angle*Math.PI/180).toFixed(3)} â‰ˆ ${answer}$`] 
            };
        }
        
        if(type === 'BOSS_PROB') {
            const prob = (this.rand(1, 3)/6).toFixed(3);
            return { 
                q: `æ ¹æ“šæ¦‚ç‡å…¬å¼ï¼Œæ“²å…©ç²’å…¬å¹³éª°å­ï¼Œæ±‚é»æ•¸å’Œç‚º $7$ çš„æ¦‚ç‡`, 
                a: `$\\frac{1}{6}$`, 
                o: [`$\\frac{1}{6}$`, `$\\frac{1}{12}$`, `$\\frac{1}{18}$`, `$\\frac{1}{36}$`], 
                s: [`ç¸½å¯èƒ½çµæœï¼š$6 \\times 6 = 36$`, `é»æ•¸å’Œç‚º7çš„çµ„åˆï¼š(1,6),(2,5),(3,4),(4,3),(5,2),(6,1) å…±6ç¨®`, `æ¦‚ç‡ = $\\frac{6}{36} = \\frac{1}{6}$`] 
            };
        }
        
        return this.generateSTR('STR_LINEAR', lv);
    }
};

const Core = {
    p: { 
        name: "", 
        str: 0, 
        int: 0, 
        wis: 0,
        luc: 0,
        dex: 0,
        vit: 0,
        level: 1,
        exp: 0
    },
    
    init() {
        if(!localStorage.getItem('math_hero_priv')) document.getElementById('privacy-notice').style.display = 'block';
        this.load();
    },
    
    acceptPrivacy() { 
        localStorage.setItem('math_hero_priv', 'true'); 
        document.getElementById('privacy-notice').style.display = 'none'; 
    },
    

    
    showAttributeMenu(attr) {
        document.getElementById('main-menu').style.display = 'none';
        document.querySelectorAll('.attribute-menu').forEach(m => m.style.display = 'none');
        document.getElementById(`menu-${attr}`).style.display = 'block';
    },
    
    backToMain() {
        document.querySelectorAll('.attribute-menu').forEach(menu => menu.style.display = 'none');
        document.getElementById('view-errors').style.display = 'none';
        document.getElementById('main-menu').style.display = 'block';
    },
    
    openErrorLog() {
        document.getElementById('main-menu').style.display = 'none';
        document.querySelectorAll('.attribute-menu').forEach(m => m.style.display = 'none');
        document.getElementById('view-errors').style.display = 'block';
        this.updateErrorUI();
    },
    
    updateErrorUI() {
        const list = document.getElementById('error-list');
        const countSpan = document.getElementById('error-count');
        countSpan.textContent = Analytics.errors.length;
        
        // æ›´æ–°éŒ¯èª¤çµ±è¨ˆ
        const stats = Analytics.getErrorStats();
        document.getElementById('error-str').textContent = stats.str;
        document.getElementById('error-int').textContent = stats.int;
        document.getElementById('error-wis').textContent = stats.wis;
        document.getElementById('error-rate').textContent = stats.errorRate + '%';
        
        if (Analytics.errors.length === 0) {
            list.innerHTML = `
                <div style="text-align:center; color:#475569; padding:40px 20px; border:2px dashed #334155; border-radius:15px; margin-top:20px;">
                    <div style="font-size:48px;">ğŸ“š</div>
                    <div style="font-size:16px; margin:10px 0; color:var(--text);">éŒ¯èª¤ä¹‹æ›¸æ˜¯ç©ºçš„</div>
                    <div style="color:#94a3b8; font-size:14px;">ä¿®ç…‰è¡¨ç¾å®Œç¾ï¼</div>
                    <button onclick="Core.backToMain()" style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:10px; margin-top:15px; cursor:pointer;">ç¹¼çºŒä¿®ç…‰</button>
                </div>`;
            return;
        }

        list.innerHTML = Analytics.errors.map((err, idx) => {
            const typeName = err.type.startsWith('STR') ? 'åŠ›é‡(STR)' : 
                            err.type.startsWith('INT') ? 'æ™ºåŠ›(INT)' : 
                            err.type.startsWith('WIS') ? 'æ™ºæ…§(WIS)' : 
                            err.type.startsWith('EXT') ? 'æ“´å±•å–®å…ƒ' : 'å…¶ä»–';
            
            const typeColor = err.type.startsWith('STR') ? 'var(--red)' : 
                             err.type.startsWith('INT') ? 'var(--accent)' : 
                             err.type.startsWith('WIS') ? 'var(--purple)' : 
                             err.type.startsWith('EXT') ? 'var(--accent)' : 'var(--gold)';
            
            return `
                <div class="error-item">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <div class="error-type" style="color:${typeColor}">
                                #${idx+1} | ${typeName} | ${err.time}
                            </div>
                            <div class="error-question">${err.q}</div>
                        </div>
                    </div>
                    
                    <div style="margin:10px 0;">
                        <details>
                            <summary style="cursor:pointer; color:var(--accent); font-size:14px; background:rgba(56,189,248,0.1); padding:8px; border-radius:5px;">
                                ğŸ“– é¡¯ç¤ºç­”æ¡ˆèˆ‡è©³è§£
                            </summary>
                            <div style="padding:10px; background:rgba(255,255,255,0.05); border-radius:5px; margin-top:5px;">
                                <div class="error-answer">æ­£ç¢ºç­”æ¡ˆï¼š${err.a}</div>
                                <div style="color:#94a3b8; font-size:12px; margin-top:8px;">
                                    <strong>è§£é¡Œæ­¥é©Ÿï¼š</strong><br>
                                    ${err.s.join('<br>')}
                                </div>
                            </div>
                        </details>
                    </div>
                    
                    <div class="error-actions">
                        <button onclick="Core.challengeError(${idx})" class="challenge-btn">ğŸ”„ é‡æ–°æŒ‘æˆ°</button>
                        <button onclick="Analytics.removeError(${idx}); Core.updateErrorUI();" class="delete-btn">ğŸ—‘ï¸ åˆªé™¤</button>
                    </div>
                </div>
            `;
        }).join('');

        // é‡æ–°æ¸²æŸ“æ•¸å­¸å…¬å¼
        MathJaxLoader.ensure(() => {
            if(window.MathJax) MathJax.typesetPromise();
        });
    },
    
    challengeError(index) {
        const errData = Analytics.errors[index];
        
        // é–‹å•Ÿç­”é¡Œè¦–çª—
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('q-body').innerHTML = DOMPurify.sanitize(errData.q);
        
        const opts = document.getElementById('q-options');
        opts.innerHTML = "";
        document.getElementById('feedback').style.display = 'none';
        document.getElementById('attribute-gain').style.display = 'none';

        // ç”Ÿæˆé¸é …ï¼ˆéš¨æ©Ÿé †åºï¼‰
        [...errData.o].sort(() => Math.random() - 0.5).forEach(o => {
            const b = document.createElement('button');
            b.className = 'opt-btn';
            b.innerHTML = o;
            b.onclick = () => {
                const ok = o === errData.a;
                if(ok) {
                    // æŒ‘æˆ°æˆåŠŸï¼šå¾æ•¸çµ„ä¸­ç§»é™¤è©²éŒ¯èª¤
                    Analytics.errors.splice(index, 1);
                    localStorage.setItem('math_hero_errors', JSON.stringify(Analytics.errors));
                    
                    // å¢åŠ å°æ‡‰å±¬æ€§
                    const attr = errData.type.startsWith('STR') ? 'str' : 
                                errData.type.startsWith('INT') ? 'int' : 
                                errData.type.startsWith('WIS') ? 'wis' : 
                                errData.type.startsWith('EXT') ? 'wis' : null;
                    if(attr) {
                        this.p[attr] += 20; // é‡åšæˆåŠŸçå‹µæ›´å¤š
                        this.p.exp += 20;
                        this.p.level = Math.floor(this.p.exp / 100) + 1;
                        
                        // éš¨æ©Ÿå¢åŠ å…¶ä»–å±¬æ€§
                        const otherAttrs = ['luc', 'dex', 'vit'];
                        const randomAttr = otherAttrs[Math.floor(Math.random() * otherAttrs.length)];
                        this.p[randomAttr] += 5;
                    }
                    
                    this.showFeedback(true, errData);
                    document.getElementById('res-title').textContent = "âœ¨ æŒ‘æˆ°æˆåŠŸï¼šéŒ¯èª¤å·²æ¸…é™¤ï¼";
                    document.getElementById('res-title').style.color = 'var(--green)';
                    
                    // é¡¯ç¤ºå±¬æ€§å¢ç›Š
                    if(attr) {
                        const attrName = attr === 'str' ? 'åŠ›é‡(STR)' : 
                                       attr === 'int' ? 'æ™ºåŠ›(INT)' : 
                                       attr === 'wis' ? 'æ™ºæ…§(WIS)' : attr.toUpperCase();
                        document.getElementById('gain-text').innerHTML = 
                            `âœ… +20 ${attrName}<br>âœ¨ å…¶ä»–å±¬æ€§ä¹Ÿæœ‰æ‰€æå‡`;
                        document.getElementById('attribute-gain').style.display = 'block';
                    }
                } else {
                    this.showFeedback(false, errData);
                    document.getElementById('res-title').textContent = "âŒ æŒ‘æˆ°å¤±æ•—ï¼šå†æ¥å†å²";
                    document.getElementById('res-title').style.color = 'var(--red)';
                }
                
                this.save();
                this.updateErrorUI();
            };
            opts.appendChild(b);
        });

        MathJaxLoader.ensure(() => {
            if(window.MathJax) MathJax.typesetPromise();
        });
    },
    
    handleSync(type) {
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('loading-spinner').style.display = 'block';
        document.getElementById('q-body').innerHTML = "";
        document.getElementById('q-options').innerHTML = "";
        document.getElementById('feedback').style.display = 'none';
        document.getElementById('attribute-gain').style.display = 'none';
        
        MathJaxLoader.ensure(() => {
            document.getElementById('loading-spinner').style.display = 'none';
            const q = Generator.safeGen(type, this.p.level);
            document.getElementById('q-body').innerHTML = DOMPurify.sanitize(q.q);
            
            const opts = document.getElementById('q-options');
            q.o.sort(()=>Math.random()-0.5).forEach(o => {
                const b = document.createElement('button');
                b.className = 'opt-btn'; 
                b.innerHTML = o;
                b.onclick = () => {
                    const ok = o === q.a;
                    Analytics.record(type, ok, q);
                    
                    if(ok) {
                        const attr = type.startsWith('STR') ? 'str' : 
                                    type.startsWith('INT') ? 'int' : 
                                    type.startsWith('WIS') ? 'wis' : 
                                    type.startsWith('EXT') ? 'wis' : null;
                        
                        if(attr) {
                            // ä¸»è¦å±¬æ€§å¢åŠ 
                            this.p[attr] += 10;
                            this.p.exp += 10;
                            
                            // éš¨æ©Ÿå¢åŠ æ¬¡è¦å±¬æ€§
                            const secondaryAttrs = ['luc', 'dex', 'vit'];
                            const randomAttr = secondaryAttrs[Math.floor(Math.random() * secondaryAttrs.length)];
                            this.p[randomAttr] += 3;
                            
                            this.p.level = Math.floor(this.p.exp / 100) + 1;
                            
                            const attrName = attr === 'str' ? 'åŠ›é‡(STR)' : 
                                           attr === 'int' ? 'æ™ºåŠ›(INT)' : 
                                           attr === 'wis' ? 'æ™ºæ…§(WIS)' : attr.toUpperCase();
                                           
                            const secAttrName = randomAttr === 'luc' ? 'å¹¸é‹(LUC)' : 
                                              randomAttr === 'dex' ? 'æ•æ·(DEX)' : 
                                              randomAttr === 'vit' ? 'é«”è³ª(VIT)' : randomAttr.toUpperCase();
                            
                            document.getElementById('gain-text').innerHTML = 
                                `âœ… +10 ${attrName}<br>âœ¨ +3 ${secAttrName}`;
                            document.getElementById('attribute-gain').style.display = 'block';
                        }
                    }
                    
                    this.showFeedback(ok, q);
                    this.save();
                };
                opts.appendChild(b);
            });
            
            if(window.MathJax) MathJax.typesetPromise();
        });
    },
    
    showFeedback(ok, q) {
        const fb = document.getElementById('feedback');
        fb.style.display = 'block';
        const resTitle = document.getElementById('res-title');
        const resSteps = document.getElementById('res-steps');
        
        if(ok) {
            resTitle.textContent = "âœ… å›ç­”æ­£ç¢ºï¼";
            resTitle.style.color = 'var(--green)';
        } else {
            resTitle.textContent = "âŒ å›ç­”éŒ¯èª¤";
            resTitle.style.color = 'var(--red)';
        }
        
        resSteps.innerHTML = '<strong>è§£é¡Œæ­¥é©Ÿï¼š</strong><br>' + q.s.join('<br>');
        Analytics.updateUI();
        this.updateUI();
        
        // é‡æ–°æ¸²æŸ“æ•¸å­¸å…¬å¼
        MathJaxLoader.ensure(() => {
            if(window.MathJax) MathJax.typesetPromise();
        });
    },
    
    exportErrors() {
        if(Analytics.errors.length === 0) {
            alert("æš«ç„¡éŒ¯èª¤è¨˜éŒ„å¯å°å‡º");
            return;
        }
        
        const exportData = {
            exportTime: new Date().toLocaleString('zh-Hant'),
            totalErrors: Analytics.errors.length,
            errors: Analytics.errors.map(err => ({
                type: err.type,
                time: err.time,
                question: err.q,
                answer: err.a,
                steps: err.s
            }))
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `éŒ¯èª¤ä¹‹æ›¸_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert(`å·²å°å‡º ${Analytics.errors.length} æ¢éŒ¯èª¤è¨˜éŒ„`);
    },
    
    clearErrors() {
        Analytics.clearErrors();
    },
    
    save() { 
        localStorage.setItem('math_hero_p', JSON.stringify(this.p)); 
        this.updateUI(); 
    },
    
    load() {
        const d = localStorage.getItem('math_hero_p');
        if(d) { 
            this.p = JSON.parse(d); 
            document.getElementById('view-setup').style.display='none'; 
            document.getElementById('view-main').style.display='block'; 
            this.updateUI(); 
        }
    },
    
updateUI() {
        // æ›´æ–°é¡¯ç¤ºæ•¸æ“š
        document.getElementById('ds-name').innerText = this.p.name;
        document.getElementById('ds-level').innerText = this.p.level;
        document.getElementById('ds-exp').innerText = this.p.exp;
        
        ['str', 'int', 'wis', 'luc', 'dex', 'vit'].forEach(k => {
            const el = document.getElementById(`stat-${k}`);
            if(el) el.innerText = this.p[k];
        });

        // æ›´æ–° BOSS æŒ‰éˆ•ç‹€æ…‹
        const bossTri = document.getElementById('btn-boss-tri');
        const bossProb = document.getElementById('btn-boss-prob');
        
        if(bossTri) bossTri.className = `opt-btn boss-btn ${this.p.str >= 100 ? 'unlocked' : ''}`;
        if(bossProb) bossProb.className = `opt-btn boss-btn ${this.p.int >= 100 ? 'unlocked' : ''}`;
        
        // æ›´æ–°ä¿®ç…‰å»ºè­°
        const recommendations = [];
        const total = this.p.str + this.p.int + this.p.wis;
        
        if(total < 50) {
            recommendations.push("ğŸ”° æ–°æ‰‹å‹‡è€…ï¼Œé–‹å§‹ä¿®ç…‰å§ï¼");
        } else if(total < 150) {
            recommendations.push("âš”ï¸ æˆé•·ä¸­çš„å‹‡è€…ï¼Œç¹¼çºŒåŠªåŠ›ï¼");
        } else if(total < 300) {
            recommendations.push("ğŸ† ç†Ÿç·´çš„å‹‡è€…ï¼ŒæŒ‘æˆ°BOSSå§ï¼");
        } else {
            recommendations.push("ğŸ‘‘ å‚³å¥‡å‹‡è€…ï¼Œç¹¼çºŒå‰µé€ è¨˜éŒ„ï¼");
        }
        
        // æ‰¾å‡ºæœ€é«˜å’Œæœ€ä½å±¬æ€§
        const mainAttrs = [
            {name: 'åŠ›é‡(STR)', value: this.p.str, key: 'str'},
            {name: 'æ™ºåŠ›(INT)', value: this.p.int, key: 'int'},
            {name: 'æ™ºæ…§(WIS)', value: this.p.wis, key: 'wis'}
        ];
        
        mainAttrs.sort((a, b) => b.value - a.value);
        
        if(mainAttrs[0].value > 0) {
            recommendations.push(`ğŸ… æœ€å¼·å±¬æ€§ï¼š${mainAttrs[0].name} (${mainAttrs[0].value})`);
        }
        
        // --- ä¿®æ­£çš„é‡é»åœ¨é€™è£¡ ---
        // ç¢ºä¿æ¨£æ¿å­—ä¸² `${...}` æ­£ç¢ºé–‰åˆ
if(mainAttrs[2].value < mainAttrs[0].value * 0.5) {
             recommendations.push(`âš ï¸ å»ºè­°åŠ å¼·ï¼š${mainAttrs[2].name}`);
        }

        const recEl = document.getElementById('ai-recommendation');
        if(recEl) recEl.innerHTML = recommendations.join('<br>');

        Analytics.updateUI();
    },

    // è£œä¸Šé€™æ®µ handleStartï¼Œç¢ºä¿æŒ‰éˆ•æœ‰åæ‡‰
    handleStart: function() {
        const nameInput = document.getElementById('in-name');
        const name = nameInput.value.trim();
        
        if (!name) {
            alert("è«‹è¼¸å…¥å‹‡è€…åç¨±ï¼");
            return;
        }

        this.p.name = name;
        
        // åˆ‡æ›ç•«é¢
        document.getElementById('ds-name').innerText = name;
        document.getElementById('view-setup').style.display = 'none';
        document.getElementById('view-main').style.display = 'block';
        
        this.updateUI();
    },

    // å…¶ä»–å¯èƒ½éœ€è¦çš„è¼”åŠ©å‡½æ•¸ (ç¢ºä¿ Core å®Œæ•´æ€§)
    backToMain: function() {
        document.querySelectorAll('.attribute-menu, #view-errors').forEach(el => el.style.display = 'none');
        document.getElementById('main-menu').style.display = 'block';
        document.getElementById('view-main').style.display = 'block';
    },

    showAttributeMenu: function(type) {
        document.getElementById('main-menu').style.display = 'none';
        const menuId = 'menu-' + type;
        const menu = document.getElementById(menuId);
        if(menu) menu.style.display = 'block';
    }

}; // é€™è£¡çµæŸ Core ç‰©ä»¶
</script>
</body>
</html>